<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-task/sensor_data_processing/Semantic-Image-Segmentation" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Semantic Image Segmentation Applied on Camera Images | Automated and Connected Driving</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Image-Segmentation"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Semantic Image Segmentation Applied on Camera Images | Automated and Connected Driving"><meta data-rh="true" name="description" content="ROS2"><meta data-rh="true" property="og:description" content="ROS2"><link data-rh="true" rel="icon" href="/Autonomous-Connected-Driving/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Image-Segmentation"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Image-Segmentation" hreflang="en"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Image-Segmentation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Autonomous-Connected-Driving/blog/rss.xml" title="Automated and Connected Driving RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Autonomous-Connected-Driving/blog/atom.xml" title="Automated and Connected Driving Atom Feed"><link rel="stylesheet" href="/Autonomous-Connected-Driving/assets/css/styles.ce2d5abf.css">
<script src="/Autonomous-Connected-Driving/assets/js/runtime~main.b1a762c2.js" defer="defer"></script>
<script src="/Autonomous-Connected-Driving/assets/js/main.62095f23.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Autonomous-Connected-Driving/"><div class="navbar__logo"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/introduction-tools/getting_started">Introduction &amp; Tools</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/sensor-data-processing/getting_started">Sensor Data Processing</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/object-fusion-tracking/getting_started">Object Fusion and Tracking</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/vehicle-guidance/getting_started">Vehicle Guidance</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/connected-driving/getting_started">Connected Driving</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Autonomous-Connected-Driving/docs/task/getting_started">Tasks</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/cpp/getting_started">C++</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/python/getting_started">Python</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros/getting_started">ROS</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros2/getting_started">ROS2</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Autonomous-Connected-Driving/docs/task/getting_started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/introduction--tools">Introduction &amp; Tools</a><button aria-label="Expand sidebar category &#x27;Introduction &amp; Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/Autonomous-Connected-Driving/docs/category/sensor-data-processing">Sensor Data Processing</a><button aria-label="Collapse sidebar category &#x27;Sensor Data Processing&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Camera-based-Semantic-Grid-Mapping">Camera-based Semantic Grid Mapping</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Deep-OGM">Deep Learning-based Point Cloud Occupancy Grid Mapping</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Geometric-OGM">Geometric Point Cloud Occupancy Grid Mapping</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Localization">Localization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Object-Detection">Object Detection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Image-Segmentation">Semantic Image Segmentation Applied on Camera Images</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Point-Cloud-Segmentation">Perform Deep Learning Based Semantic Point Cloud Segmentation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/object-fusion-tracking">Object Fusion Tracking</a><button aria-label="Expand sidebar category &#x27;Object Fusion Tracking&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/vehicle-guidance">Vehicle Guidance</a><button aria-label="Expand sidebar category &#x27;Vehicle Guidance&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/connected-driving">Connected Driving</a><button aria-label="Expand sidebar category &#x27;Connected Driving&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Autonomous-Connected-Driving/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/Autonomous-Connected-Driving/docs/category/sensor-data-processing"><span itemprop="name">Sensor Data Processing</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Semantic Image Segmentation Applied on Camera Images</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Semantic Image Segmentation Applied on Camera Images</h1></header>
<p><img decoding="async" loading="lazy" src="https://img.shields.io/badge/ROS2-red" alt="ROS2" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Image Segmentation" src="/Autonomous-Connected-Driving/assets/images/image_segmentation-b35830485d68cc7ff142254e2516ebe7.png" width="1534" height="392" class="img_ev3q"></p>
<p>In this workshop, we will perform <strong>semantic image segmentation</strong> on raw camera data using a deep learning model. In particular, we will take a recording from our test vehicle which is equipped with a on board camera and we will apply the segmentation model on the sensor data stream.</p>
<p>The learning goals of this workshop are</p>
<ul>
<li>Inspect a rosbag which contains camera data</li>
<li>Learn about ROS2 standard camera and camera info message format</li>
<li>Learn about a simple Python inference node for semantic image segmentation</li>
<li>Learn to visualize the output of semantic image segmentation</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="start-the-docker-environment">Start the Docker Environment<a href="#start-the-docker-environment" class="hash-link" aria-label="Direct link to Start the Docker Environment" title="Direct link to Start the Docker Environment">​</a></h2>
<p>Navigate to the local directory <code>${REPOSITORY}/docker</code> and execute <code>./ros2_run.sh</code>. This will start the Docker container, in which ROS and all required libraries are preinstalled. You can stop the container by pressing <kbd>Ctrl</kbd>+<kbd>C</kbd> in the terminal. If everything is setup correctly you will see the following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Starting new container...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=== CONTAINER INFORMATION ======================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Architecture: x86_64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ubuntu: 22.04.2 LTS (Jammy Jellyfish)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Python: 3.10.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ROS: humble</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMake: 3.22.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CUDA: 12.1.105</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cuDNN: 8.9.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TensorRT: 8.6.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TensorFlow Python: 2.13.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TensorFlow C/C++: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PyTorch Python: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PyTorch C/C++: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Available GPUs: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name               driver_version   utilization.gpu [%]   utilization.memory [%]   memory.used [MiB]   memory.total [MiB]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NVIDIA TITAN RTX   470.182.03       0 %                   2 %                      552 MiB             24217 MiB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">===============================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@******:/home/rosuser/ws/colcon_workspace# </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>acdc</code> folder is mounted from your host into the container. Note that your current working directory inside the container is <code>/home/rosuser/ws/colcon_workspace</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="download-and-inspect-bag-file">Download and Inspect Bag file<a href="#download-and-inspect-bag-file" class="hash-link" aria-label="Direct link to Download and Inspect Bag file" title="Direct link to Download and Inspect Bag file">​</a></h2>
<p>Download the rosbag <code>left_camera_templergraben.db3</code> from <a href="https://rwth-aachen.sciebo.de/s/QxGbpvIQF4Mk8Uo" target="_blank" rel="noopener noreferrer"><strong>here (1.2 GB)</strong></a>.</p>
<p>Save this file to your local directory <code>${REPOSITORY}/bag</code>. This directory will be mounted into the docker container to the path <code>/home/rosuser/ws/bag</code>.</p>
<p>You can start the docker container now with <code>./ros2_run.sh</code> (if you haven&#x27;t already).</p>
<p>Inside the container, you can navigate to <code>/home/rosuser/ws/bag</code> and execute <code>ros2 bag info left_camera_templergraben.db3</code> to inspect the rosbag:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">~/bag$ ros2 bag info lef_camera_templegraben</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Files:             left_camera_templergraben.db3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bag size:          1.2 GiB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Storage id:        sqlite3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration:          17.999s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start:             Aug  9 2019 10:59:01.823 (1565341141.823)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End:               Aug  9 2019 10:59:19.823 (1565341159.823)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Messages:          2881</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Topic information: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Topic: /tf | Type: tf2_msgs/msg/TFMessage | Count: 1801 | Serialization Format: cdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Topic: /sensors/camera/left/camera_info | </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: sensor_msgs/msg/CameraInfo | Count: 540 | Serialization </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Format: cdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Topic: /sensors/camera/left/image_raw | </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Type: sensor_msgs/msg/Image | Count: 540 |  Serialization </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Format: cdr</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see that the rosbag has a duration of 18 seconds and contains 540 image frames of type <code>sensor_msgs/Image</code> and 540 corresponding <code>sensor_msgs/CameraInfo</code> messages. We will use these camera images in this assignment in order to apply image segmentation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros2s-sensor_msgsmsgimage-message">ROS2&#x27;s <code>sensor_msgs/msg/Image</code> Message<a href="#ros2s-sensor_msgsmsgimage-message" class="hash-link" aria-label="Direct link to ros2s-sensor_msgsmsgimage-message" title="Direct link to ros2s-sensor_msgsmsgimage-message">​</a></h2>
<p>The message definition <a href="https://docs.ros2.org/latest/api/sensor_msgs/msg/Image.html" target="_blank" rel="noopener noreferrer">sensor_msgs/msg/Image</a> is ROS2&#x27;s standard image message format. It is used for all kind of camera image message types and can be used seamlessly with many different ROS2 visualization and image processing tools. Please read the documentation about the <a href="https://docs.ros2.org/latest/api/sensor_msgs/msg/Image.html" target="_blank" rel="noopener noreferrer">detailed message format</a> and it&#x27;s content.
Message</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros2s-sensor_msgsmsgcamerainfo-message">ROS2&#x27;s <code>sensor_msgs/msg/CameraInfo</code> Message<a href="#ros2s-sensor_msgsmsgcamerainfo-message" class="hash-link" aria-label="Direct link to ros2s-sensor_msgsmsgcamerainfo-message" title="Direct link to ros2s-sensor_msgsmsgcamerainfo-message">​</a></h2>
<p>The message definition <a href="hhttps://docs.ros2.org/latest/api/sensor_msgs/msg/CameraInfo.html" target="_blank" rel="noopener noreferrer">sensor_msgs/msg/CameraInfo</a> is ROS2&#x27;s standard camera info message format. It is send together with <code>sensor_msgs/msg/Image</code> to provide additional information about the current camera image such as <strong>camera calibration parameters</strong>. Feel free to read the documentation about the <a href="https://docs.ros2.org/latest/api/sensor_msgs/msg/CameraInfo.html" target="_blank" rel="noopener noreferrer">detailed message format</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-and-source-the-package">Build and source the package<a href="#build-and-source-the-package" class="hash-link" aria-label="Direct link to Build and source the package" title="Direct link to Build and source the package">​</a></h2>
<p>The code for the image segmentation inference node can be found in the directory <code>colcon_workspace/src/section_2/image_segmentation_r2</code>. The structure of this <strong>Python package</strong> is illustrated in the following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">image_segmentation_r2/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── package.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── setup.cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── params.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── image_segmentation_r2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── image_segmentation.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── img_utils.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── __init__.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── launch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── image_segmentation_r2.launch.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── convert_cityscapes_to_ika_reduced.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── mobilenet_v3_large_968_608_os8.pb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── mobilenet_v3_small_968_608_os8.pb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── test</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The main source code is located in the directory <code>image_segmentation_r2</code>, the pretrained segmentation models are located in <code>models</code> and the launch file are located in directory <code>launch</code>and parameters are located in <code>config</code>. Feel free to read all the code, parameters and launch files.</p>
<p>Note, that we provide here two image segmentation models for you. Both rely on the MobilnetV3 architecture:</p>
<ul>
<li><code>mobilenet_v3_large_968_608_os8.pb</code>: Larger model, slower inference, more RAM needed</li>
<li><code>mobilenet_v3_small_968_608_os8.pb</code>: Smaller model, faster inference, less RAM needed</li>
</ul>
<p>These models are trained on a much larger dataset compared to the model you have trained in the exercise, but the overall training pipeline and additional augmentation methods applied during the training are almost identical.</p>
<p>You might change the model in the <code>params.yaml</code> configuration file depending on the capabilities of your computer.</p>
<p>Now, let&#x27;s build the package with with <code>colcon build</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-select image_segmentation_r2 --symlink-install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perfect! Now you will be able to perform inference on camera images with this package. Let&#x27;s go to the next section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replay-rosbag-and-run-image-segmentation">Replay rosbag and run image segmentation<a href="#replay-rosbag-and-run-image-segmentation" class="hash-link" aria-label="Direct link to Replay rosbag and run image segmentation" title="Direct link to Replay rosbag and run image segmentation">​</a></h2>
<p>We have already prepared a launch file for you to execute the image segmentation. Please read carefully through the following lines of code.</p>
<p>Contents of the file <code>image_segmentation_r2.launch.py</code>:</p>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ament_index_python</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">packages </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> get_package_share_directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> launch </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LaunchDescription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> launch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actions </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DeclareLaunchArgument</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> launch_ros</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actions </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> launch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actions </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ExecuteProcess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generate_launch_description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get the package and params directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image_segmentation_dir </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_package_share_directory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;image_segmentation_r2&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image_segmentation_dir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;config&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;params.yaml&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Declare launch arguments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_sim_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DeclareLaunchArgument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;use_sim_time&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default_value</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Use simulation clock time&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ROSBAG PLAY node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rosbag_play_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ExecuteProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cmd</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ros2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bag&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;play&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;--rate&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0.05&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;-l&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;/home/rosuser/ws/bag/left_camera_templergraben&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;--topics&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/sensors/camera/left/image_raw&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             </span><span class="token string" style="color:#e3116c">&#x27;/sensors/camera/left/camera_info&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;screen&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># IMAGE_PROC node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image_proc_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_proc&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_proc&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executable</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_proc&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;sensors/camera/left&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;screen&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remappings</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;image_raw&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># CAMERA SEGMENTATION NODE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    camera_segmentation_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_segmentation_r2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_segmentation&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executable</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_segmentation&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;screen&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parameters</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remappings</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;image_color&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;sensors/camera/left/image_color&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># NODES FOR VISUALIZATION</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    segmentation_viewer_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_view&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executable</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_view&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;segmentatibashon_viewer&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remappings</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;image_segmented&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">ros2 launch image_segmentation_py start_all</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">launch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    camera_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        package</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_view&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        executable</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;image_view&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;camera_viewer&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remappings</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;image&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;sensors/camera/left/image_color&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parameters</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;autosize&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Create the launch description and populate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LaunchDescription</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Add the actions to the launch description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">use_sim_time</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rosbag_play_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">image_proc_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">camera_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">camera_segmentation_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">segmentation_viewer_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ld</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hence, we perform the following tasks:</p>
<ul>
<li><strong>Replay the rosbag</strong> with a speed of 0.05. Note, that we set the speed to a very low value here, because your computer might be very slow. You can adapt this values if your computer is fast enough to compute the segmentation at a higher speed.</li>
<li><strong>Apply <code>image_proc</code></strong> to the raw sensor data. The topic <code>/sensors/camera/left/image_raw</code> was recorded in the raw data format. With <code>image_proc</code> we convert it to a RGB encoding. Read more <a href="https://wiki.ros.org/image_proc" target="_blank" rel="noopener noreferrer">here</a> about it.</li>
<li><strong>Start the <code>image_segmentation</code></strong> node and feed it with the correct topic name and load the parameters that are necessary for the node.</li>
<li>Start two <strong>nodes for visualization</strong></li>
</ul>
<p>Note: You can also use RVIZ to visualize the RGB camera image and the segmented camera image.</p>
<p>We can now start the launch file with:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch image_segmentation_r2 image_segmentation_r2.launch.py </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>image_view</code> node should show you directly the camera image as shown in this image:</p>
<p><img decoding="async" loading="lazy" alt="Image Segmentation" src="/Autonomous-Connected-Driving/assets/images/city-9e40a2d7d1cc1eb07396b4786905ae0b.png" width="1612" height="883" class="img_ev3q"></p>
<p>However, the segmented image looks like this</p>
<p><img decoding="async" loading="lazy" alt="Image Segmentation" src="/Autonomous-Connected-Driving/assets/images/image_rect_segmented-c427d0ce5043e23c8aa84456efafd8b2.png" width="967" height="640" class="img_ev3q"></p>
<p>Something is wrong. We have apparently a bug in the code !!! Let&#x27;s solve this problem.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="review-of-file-image_segmentationpy">Review of file image_segmentation.py<a href="#review-of-file-image_segmentationpy" class="hash-link" aria-label="Direct link to Review of file image_segmentation.py" title="Direct link to Review of file image_segmentation.py">​</a></h2>
<p>Before we start with the task, let&#x27;s try to understand what happens in the file <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/image_segmentation_r2/image_segmentation_r2/image_segmentation.py" target="_blank" rel="noopener noreferrer"><code>image_segmentation.py</code></a>.</p>
<p>The file <code>image_segmentation.py</code> contains the inference node for the image segmentation task. The inference node is implemented as a Python class called <code>ImageSegmentation</code>. The class has the following member functions. We will give here a short description of each class so you can understand what each class is doing.</p>
<ul>
<li>
<p><strong>class ImageSegmentation</strong></p>
<p><em>Class which implements image segmentation inference applied on images send as ROS2 MSG of type <code>sensor_msgs/msg/Image</code></em></p>
<ul>
<li><strong><code>__init__(self)</code></strong></li>
</ul>
<p><em>Initializes the class by initializing it with a ROS Node. Calls
<code>setup()</code> and <code>load_parameters()</code> to load the model and necessary parameters.</em></p>
<ul>
<li><strong>load_parameters(self)</strong></li>
</ul>
<p><em>Loads the ROS params and stores them into the current instance of ImageSegmentation</em></p>
<ul>
<li><strong>setup(self)</strong></li>
</ul>
<p><em>Loads the image segmentation model which are stored in the directory <code>models</code>. Also creates a <code>cv_bridge</code> which allows to convert <code>sensor_msgs/msg/Image</code> into an image which can be processed by the neural network. Also registers subscribers and publishers.</em></p>
<ul>
<li><strong>predict(self, img_color_msg)</strong></li>
</ul>
<p><em>This is the so called callback function. This function is triggered, when the subscriber <code>self.sub_image</code> receives a message on topic <code>&quot;/image_color&quot;</code>. This function performs the actual inference of the neural network. It converts the <code>sensor_msgs/msg/Image</code> message into a format that can be processed by the neural network, then performs the inference and then converts the output, a segmentation maps, into a RGB encoding which is then send as an image using publisher <code>self.pub_seg</code></em></p>
<ul>
<li><strong>load_frozen_graph(path_to_frozen_graph)</strong></li>
</ul>
<p><em>Takes the path to one of the models stored in the directory <code>models</code> and converts the frozen graph into an executable Python function. Uses helper function <code>wrap_frozen_graph()</code></em></p>
<ul>
<li><strong>wrap_frozen_graph(graph_def, inputs, outputs, print_graph=False)</strong></li>
</ul>
<p><em>Helper function that converts a frozen graph, which is a type how a neural network can be stored using Tensorflow, into an executable Python function</em></p>
<ul>
<li><strong>segmentation_map_to_rgb(segmentation_map)</strong></li>
</ul>
<p><em>A function which converts a segmentation map into RGB encoded image</em></p>
<ul>
<li><strong>parse_convert_xml(conversion_file_path)</strong></li>
</ul>
<p><em>Reads a xml file which is located in <code>models</code> and which contains information which class ID is associated with which RGB value and vice versa. It processes the xml file in such a way that it can be used to convert a segmentation map in to an RGB encoded image.</em></p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-implement-conversion-from-segmentation-map-to-rgb-encoding">Task 1: Implement conversion from segmentation map to RGB encoding<a href="#task-1-implement-conversion-from-segmentation-map-to-rgb-encoding" class="hash-link" aria-label="Direct link to Task 1: Implement conversion from segmentation map to RGB encoding" title="Direct link to Task 1: Implement conversion from segmentation map to RGB encoding">​</a></h2>
<p>Unfortunately, the function <code>segmentation_map_to_rgb()</code> in the file <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_2/image_segmentation_py/src/image_segmentation.py" target="_blank" rel="noopener noreferrer"><code>image_segmentation.py</code></a> wasn&#x27;t implemented correctly. Open this file with your favorite code editor and let&#x27;s have a look on this function.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">segmentation_map_to_rgb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> segmentation_map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Converts segmentation map to a RGB encoding according to self.color_palette</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Eg. 0 (Class 0) -&gt; Pixel value [128, 64, 128] which is on index 0 of self.color_palette</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        1 (Class 1) -&gt; Pixel value [244, 35, 232] which is on index 1 of self.color_palette</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    self.color_palette has shape [256, 3]. Each index of the first dimension is associated</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    with an RGB value. The index corresponds to the class ID.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param segmentation_map: ndarray numpy with shape (height, width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: RGB encoding with shape (height, width, 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">### START CODE HERE ###</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Replace the following command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb_encoding </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        low</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        high</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resize_height</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resize_width</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">### END CODE HERE ###</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rgb_encoding</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Instead of computing the RGB encoding from the segmentation map, the function generates only a random image. <strong>Your task</strong> is now to implement the function correctly.  Note that <code>self.color_palette</code> is here not a function parameter but a class attribute of the class <code>ImageSegmentation</code>.</p>
<p><strong>Hints</strong></p>
<ul>
<li>There are several approaches how to convert from segmentation map to the color encoding</li>
<li><strong>Loop approach:</strong> Iterate over all class IDs in segmentation map and retrieve the corresponding RGB value for each class and place this triplet (R,G,B) at the correct location of the returned RGB image.</li>
<li><strong>Advanced vectorized approach:</strong> Should be the faster and more efficient implementation. Avoid using a loop, but rather rely on numpy&#x27;s vectorized indexing operations!</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expected-output">Expected output<a href="#expected-output" class="hash-link" aria-label="Direct link to Expected output" title="Direct link to Expected output">​</a></h3>
<p>After fixing the function <code>segmentation_map_to_rgb()</code>, you will see that the inference node now will publish correct RGB encoded segmentations of the camera image. You will obtain segmented images as shown here:</p>
<p><img decoding="async" loading="lazy" alt="Image Segmentation" src="/Autonomous-Connected-Driving/assets/images/sem_seg-29a08be97f9d5afe2713b77125c33dee.png" width="973" height="607" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap-up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap-up" title="Direct link to Wrap-up">​</a></h2>
<ul>
<li>You learned about the ROS2 definitions for camera images and camera info messages</li>
<li>You learned about a simple Python ROS2 package for semantic image segmentation</li>
<li>You learned about encoding the segmentation map to the RGB encoding</li>
<li>You learned about <code>image_view</code>, a node for visualizing image data</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros1-instructions">ROS1 Instructions<a href="#ros1-instructions" class="hash-link" aria-label="Direct link to ROS1 Instructions" title="Direct link to ROS1 Instructions">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://img.shields.io/badge/ROS1-blue" alt="ROS1" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="Image Segmentation" src="/Autonomous-Connected-Driving/assets/images/image_segmentation-b35830485d68cc7ff142254e2516ebe7.png" width="1534" height="392" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="perform-deep-learning-based-semantic-image-segmentation-applied-on-camera-images">Perform Deep Learning based semantic image segmentation applied on camera images<a href="#perform-deep-learning-based-semantic-image-segmentation-applied-on-camera-images" class="hash-link" aria-label="Direct link to Perform Deep Learning based semantic image segmentation applied on camera images" title="Direct link to Perform Deep Learning based semantic image segmentation applied on camera images">​</a></h4>
<p>In this workshop, we will perform <strong>semantic image segmentation</strong> on raw camera data using a deep learning model. In particular, we will take a recording from our test vehicle which is equipped with a on board camera and we will apply the segmentation model on the sensor data stream.</p>
<p>The learning goals of this workshop are</p>
<ul>
<li>Inspect a rosbag which contains camera data</li>
<li>Learn about ROS&#x27; standard camera and camera info message format</li>
<li>Learn about a simple Python inference node for semantic image segmentation</li>
<li>Learn to visualize the output of semantic image segmentation</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="start-the-docker-environment-1">Start the Docker Environment<a href="#start-the-docker-environment-1" class="hash-link" aria-label="Direct link to Start the Docker Environment" title="Direct link to Start the Docker Environment">​</a></h3>
<p>Navigate to the local directory <code>${REPOSITORY}/docker</code> and execute <code>./ros1_run.sh</code>. This will start the Docker container, in which ROS and all required libraries are preinstalled. You can stop the container by pressing <kbd>Ctrl</kbd>+<kbd>C</kbd> in the terminal. If everything is setup correctly you will see the following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Starting container ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting container in mode: gpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">non-network local connections being added to access control list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Container setup:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Ubuntu: 20.04.2 LTS (Focal Fossa) (user: rosuser, password: rosuser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- CUDA: Cuda compilation tools, release 11.2, V11.2.152</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- cuDNN: 8.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- TensorRT: 8.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- TensorFlow Python3: 2.6.0 (GPUs available: 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- TensorFlow C/C++: 2.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ROS: noetic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- CMake: cmake version 3.12.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Template Commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Create new ROS package:            ros-add-package</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Add node to package:               ros-add-node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Add nodelet to package:            ros-add-nodelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Initialize ROS GitLab repository:  ros-init-repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The container is running. Execute the run script again from another terminal to open a shell in the container or press `CTRL-C` to stop the container.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>From another terminal, execute <code>./ros1_run.sh</code> again to open a shell in the running container. You should see this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Attaching to running container ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">===================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">= ROS Docker Container                                            =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">===================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is the image.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rosuser@******:~/ws/catkin_workspace$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>acdc</code> folder is mounted from your host into the container. Note that your current working directory inside the container is <code>/home/rosuser/ws/catkin_workspace</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="download-and-inspect-bag-file-1">Download and Inspect Bag file<a href="#download-and-inspect-bag-file-1" class="hash-link" aria-label="Direct link to Download and Inspect Bag file" title="Direct link to Download and Inspect Bag file">​</a></h2>
<p>Download the file <code>left_camera_templergraben.bag</code> from <a href="https://rwth-aachen.sciebo.de/s/sbSBamXYCfQw9kM" target="_blank" rel="noopener noreferrer"><strong>here (1.2 GB)</strong></a>.</p>
<p>Save this file to your local directory <code>${REPOSITORY}/bag</code>. This directory will be mounted into the docker container to the path <code>/home/rosuser/ws/bag</code>.</p>
<p>You can start the docker container now with <code>./ros1_run.sh</code> (if you haven&#x27;t already).</p>
<p>Inside the container, you can navigate to <code>/home/rosuser/ws/bag</code> and execute <code>rosbag info left_camera_templergraben.bag</code> to inspect the rosbag:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rosuser@i2000033:~/ws/bag$ rosbag info left_camera_templergraben.bag </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path:        left_camera_templergraben.bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version:     2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">duration:    18.0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start:       Aug 09 2019 10:59:01.82 (1565341141.82)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end:         Aug 09 2019 10:59:19.82 (1565341159.82)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">size:        1.2 GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages:    2881</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compression: none [541/541 chunks]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">types:       sensor_msgs/CameraInfo [c9a58c1b0b154e0e6da7578cb991d214]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             sensor_msgs/Image      [060021388200f6f0f447d0fcd9c64743]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             tf2_msgs/TFMessage     [94810edda583a504dfda3829e70d7eec]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">topics:      /sensors/camera/left/camera_info    540 msgs    : sensor_msgs/CameraInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             /sensors/camera/left/image_raw      540 msgs    : sensor_msgs/Image     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             /tf                                1801 msgs    : tf2_msgs/TFMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see that the rosbag has a duration of 18 seconds and contains 540 image frames of type <code>sensor_msgs/Image</code> and 540 corresponding <code>sensor_msgs/CameraInfo</code> messages. We will use these camera images in this assignment in order to apply image segmentation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros-sensor_msgsimage-message">ROS&#x27; <code>sensor_msgs/Image</code> Message<a href="#ros-sensor_msgsimage-message" class="hash-link" aria-label="Direct link to ros-sensor_msgsimage-message" title="Direct link to ros-sensor_msgsimage-message">​</a></h2>
<p>The message definition <a href="https://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html" target="_blank" rel="noopener noreferrer">sensor_msgs/Image</a> is ROS&#x27; standard image message format. It is used for all kind of camera image message types and can be used seamlessly with many different ROS visualization and image processing tools. Please read the documentation about the <a href="https://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html" target="_blank" rel="noopener noreferrer">detailed message format</a> and it&#x27;s content.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros-sensor_msgscamerainfo">ROS&#x27; <code>sensor_msgs/CameraInfo</code><a href="#ros-sensor_msgscamerainfo" class="hash-link" aria-label="Direct link to ros-sensor_msgscamerainfo" title="Direct link to ros-sensor_msgscamerainfo">​</a></h2>
<p>The message definition <a href="https://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/CameraInfo.html" target="_blank" rel="noopener noreferrer">sensor_msgs/CameraInfo</a> is ROS&#x27; standard camera info message format. It is send together with <code>sensor_msgs/Image</code> to provide additional information about the current camera image such as <strong>camera calibration parameters</strong>. Feel free to read the documentation about the <a href="https://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/CameraInfo.html" target="_blank" rel="noopener noreferrer">detailed message format</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-and-source-the-package-1">Build and source the package<a href="#build-and-source-the-package-1" class="hash-link" aria-label="Direct link to Build and source the package" title="Direct link to Build and source the package">​</a></h2>
<p>The code for the image segmentation inference node can be found in the directory <code>workshops/section_2/image_segmentation_py</code>. The structure of this <strong>Python package</strong> is illustrated in the following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">image_segmentation_py/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── package.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── CMakeLists.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── launch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── params.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── start_all.launch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── convert_cityscapes_to_ika_reduced.xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── mobilenet_v3_large_968_608_os8.pb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── mobilenet_v3_small_968_608_os8.pb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── image_segmentation.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── img_utils.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The main source code is located in the directory <code>src</code>, the pretrained segmentation models are located in <code>models</code> and the launch file and parameters are located in directory <code>launch</code>. Feel free to read all the code, parameters and launch files.</p>
<p>Note, that we provide here two image segmentation models for you. Both rely on the MobilnetV3 architecture:</p>
<ul>
<li><code>mobilenet_v3_large_968_608_os8.pb</code>: Larger model, slower inference, more RAM needed</li>
<li><code>mobilenet_v3_small_968_608_os8.pb</code>: Smaller model, faster inference, less RAM needed</li>
</ul>
<p>These models are trained on a much larger dataset compared to the model you have trained in the exercise, but the overall training pipeline and additional augmentation methods applied during the training are almost identical.</p>
<p>You might change the model in the <code>params.yaml</code> configuration file depending on the capabilities of your computer.</p>
<p>Now, let&#x27;s build the package with with <code>catkin build</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">catkin build image_segmentation_py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source devel/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perfect! Now you will be able to perform inference on camera images with this package. Let&#x27;s go to the next section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="replay-rosbag-and-run-image-segmentation-1">Replay rosbag and run image segmentation<a href="#replay-rosbag-and-run-image-segmentation-1" class="hash-link" aria-label="Direct link to Replay rosbag and run image segmentation" title="Direct link to Replay rosbag and run image segmentation">​</a></h2>
<p>We have already prepared a launch file for you to execute the image segmentation. Please read carefully through the following lines of code.</p>
<p>Contents of the file <code>start_all.launch</code>:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">launch</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">param</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/use_sim_time</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">true</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ROSBAG PLAY --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">node</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">pkg</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">rosbag</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">play</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">player</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">output</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">screen</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">args</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">--rate 0.05 -s 0 --clock /home/rosuser/bag/left_camera_templergraben.bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">                --topics /sensors/camera/left/image_raw</span><br></span><span class="token-line" style="color:#393A34"><span class="token tag attr-value" style="color:#e3116c">                         /sensors/camera/left/camera_info</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">node</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- STEREO IMAGE PROC --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">node</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">stereo_image_proc</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">pkg</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">stereo_image_proc</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">stereo_image_proc</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">ns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">sensors/camera/</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">output</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">screen</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">node</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!--- CAMERA SEGMENTATION NODE --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">rosparam</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">command</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">load</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">file</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">$(find image_segmentation_py)/launch/params.yaml</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">node</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">        </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_segmentation</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">        </span><span class="token tag attr-name" style="color:#00a4db">pkg</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_segmentation_py</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">        </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_segmentation.py</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">        </span><span class="token tag attr-name" style="color:#00a4db">output</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">screen</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">remap</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">from</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/image_rect_color</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">to</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/sensors/camera/left/image_rect_color</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">node</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!--- NODES FOR VISUALIZATION --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">node</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">pkg</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_view</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_view</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">segmentation_viewer</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">args</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image:=/image_rect_segmented</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">node</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">node</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">pkg</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_view</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image_view</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">camera_left</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">          </span><span class="token tag attr-name" style="color:#00a4db">args</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">image:=/sensors/camera/left/image_rect_color</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">node</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">launch</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hence, we perform the following tasks:</p>
<ul>
<li><strong>Replay the rosbag</strong> with a speed of 0.05. Note, that we set the speed to a very low value here, because your computer might be very slow. You can adapt this values if your computer is fast enough to compute the segmentation at a higher speed.</li>
<li><strong>Apply <code>stereo_image_proc</code></strong> to the raw sensor data. The topic <code>/sensors/camera/left/image_raw</code> was recorded in the raw data format. With <code>stereo_image_proc</code> we convert it to a RGB encoding. Read more <a href="https://wiki.ros.org/stereo_image_proc" target="_blank" rel="noopener noreferrer">here</a> about it.</li>
<li><strong>Load the parameters</strong> that are necessary for the <code>image_segmentation_py</code> node</li>
<li><strong>Start the <code>image_segmentation_py</code></strong> node and feed it with the correct topic name</li>
<li>Start two <strong>nodes for visualization</strong></li>
</ul>
<p>Note: You can also use RVIZ to visualize the RGB camera image and the segmented camera image.</p>
<p>We can now start the launch file with:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch image_segmentation_py start_all.launch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>image_view</code> node should show you directly the camera image as shown in this image:</p>
<img src="../images/96116c6f4b59104e706cb4b425d7afad/image.png" alt="Description of image">
<p>However, the segmented image looks like this</p>
<img src="../images/6a552394d42276e58d491197bad6547d/image.png" alt="Description of image">
<p>Something is wrong. We have apparently a bug in the code !!! Let&#x27;s solve this problem.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="review-of-file-image_segmentationpy-1">Review of file image_segmentation.py<a href="#review-of-file-image_segmentationpy-1" class="hash-link" aria-label="Direct link to Review of file image_segmentation.py" title="Direct link to Review of file image_segmentation.py">​</a></h2>
<p>Before we start with the task, let&#x27;s try to understand what happens in the file <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_2/image_segmentation_py/src/image_segmentation.py" target="_blank" rel="noopener noreferrer"><code>image_segmentation.py</code></a>.</p>
<p>The file <code>image_segmentation.py</code> contains the inference node for the image segmentation task. The inference node is implemented as a Python class called <code>ImageSegmentation</code>. The class has the following member functions. We will give here a short description of each class so you can understand what each class is doing.</p>
<ul>
<li>
<p><strong>class ImageSegmentation</strong></p>
<p><em>Class which implements image segmentation inference applied on images send as ROS MSG of type <code>sensor_msgs/Image</code></em></p>
<ul>
<li><strong><code>__init__(self)</code></strong></li>
</ul>
<p><em>Initializes the class by initializing it with a ROS Node. Calls <code>setup()</code> and <code>load_parameters()</code> to load the model and necessary parameters.</em></p>
<ul>
<li><strong>load_parameters(self)</strong></li>
</ul>
<p><em>Loads the ROS params and stores them into the current instance of ImageSegmentation</em></p>
<ul>
<li><strong>setup(self)</strong></li>
</ul>
<p><em>Loads the image segmentation model which are stored in the directory <code>models</code>. Also creates a <code>cv_bridge</code> which allows to convert <code>sensor_msgs/Image</code> into an image which can be processed by the neural network. Also registers subscribers and publishers.</em></p>
<ul>
<li><strong>predict(self, img_rect_color_msg)</strong></li>
</ul>
<p><em>This is the so called callback function. This function is triggered, when the subscriber <code>self.sub_image</code> receives a message on topic <code>&quot;/image_rect_color&quot;</code>. This function performs the actual inference of the neural network. It converts the <code>sensor_msgs/Image</code> message into a format that can be processed by the neural network, then performs the inference and then converts the output, a segmentation maps, into a RGB encoding which is then send as an image using publisher <code>self.pub_seg</code></em></p>
<ul>
<li><strong>load_frozen_graph(path_to_frozen_graph)</strong></li>
</ul>
<p><em>Takes the path to one of the models stored in the directory <code>models</code> and converts the frozen graph into an executable Python function. Uses helper function <code>wrap_frozen_graph()</code></em></p>
<ul>
<li><strong>wrap_frozen_graph(graph_def, inputs, outputs, print_graph=False)</strong></li>
</ul>
<p><em>Helper function that converts a frozen graph, which is a type how a neural network can be stored using Tensorflow, into an executable Python function</em></p>
<ul>
<li><strong>segmentation_map_to_rgb(segmentation_map)</strong></li>
</ul>
<p><em>A function which converts a segmentation map into RGB encoded image</em></p>
<ul>
<li><strong>parse_convert_xml(conversion_file_path)</strong></li>
</ul>
<p><em>Reads a xml file which is located in <code>models</code> and which contains information which class ID is associated with which RGB value and vice versa. It processes the xml file in such a way that it can be used to convert a segmentation map in to an RGB encoded image.</em></p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-implement-conversion-from-segmentation-map-to-rgb-encoding-1">Task 1: Implement conversion from segmentation map to RGB encoding<a href="#task-1-implement-conversion-from-segmentation-map-to-rgb-encoding-1" class="hash-link" aria-label="Direct link to Task 1: Implement conversion from segmentation map to RGB encoding" title="Direct link to Task 1: Implement conversion from segmentation map to RGB encoding">​</a></h2>
<p>Unfortunately, the function <code>segmentation_map_to_rgb()</code> in the file <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_2/image_segmentation_py/src/image_segmentation.py" target="_blank" rel="noopener noreferrer"><code>image_segmentation.py</code></a> wasn&#x27;t implemented correctly. Open this file with your favorite code editor and let&#x27;s have a look on this function.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">segmentation_map_to_rgb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> segmentation_map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Converts segmentation map to a RGB encoding according to self.color_palette</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Eg. 0 (Class 0) -&gt; Pixel value [128, 64, 128] which is on index 0 of self.color_palette</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        1 (Class 1) -&gt; Pixel value [244, 35, 232] which is on index 1 of self.color_palette</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    self.color_palette has shape [256, 3]. Each index of the first dimension is associated</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    with an RGB value. The index corresponds to the class ID.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param segmentation_map: ndarray numpy with shape (height, width)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: RGB encoding with shape (height, width, 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">### START CODE HERE ###</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Replace the following command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rgb_encoding </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        low</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        high</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resize_height</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resize_width</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">### END CODE HERE ###</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rgb_encoding</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Instead of computing the RGB encoding from the segmentation map, the function generates only a random image. <strong>Your task</strong> is now to implement the function correctly.  Note that <code>self.color_palette</code> is here not a function parameter but a class attribute of the class <code>ImageSegmentation</code>.</p>
<p><strong>Hints</strong></p>
<ul>
<li>There are several approaches how to convert from segmentation map to the color encoding</li>
<li><strong>Loop approach:</strong> Iterate over all class IDs in segmentation map and retrieve the corresponding RGB value for each class and place this triplet (R,G,B) at the correct location of the returned RGB image.</li>
<li><strong>Advanced vectorized approach:</strong> Should be the faster and more efficient implementation. Avoid using a loop, but rather rely on numpy&#x27;s vectorized indexing operations!</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="expected-output-1">Expected output<a href="#expected-output-1" class="hash-link" aria-label="Direct link to Expected output" title="Direct link to Expected output">​</a></h4>
<p>After fixing the function <code>segmentation_map_to_rgb()</code>, you will see that the inference node now will publish correct RGB encoded segmentations of the camera image. You will obtain segmented images as shown here:</p>
<img src="../images/uploads/f3f5b8942b8d2a32363ca9560bafdf14/image.png" alt="Description of image">
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up-1">Wrap-up<a href="#wrap-up-1" class="hash-link" aria-label="Direct link to Wrap-up" title="Direct link to Wrap-up">​</a></h2>
<ul>
<li>You learned about the ROS definitions for camera images and camera info messages</li>
<li>You learned about a simple Python ROS package for semantic image segmentation</li>
<li>You learned about encoding the segmentation map to the RGB encoding</li>
<li>You learned about <code>image_view</code>, a node for visualizing image data</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/task/02_sensor_data_processing/06_Semantic-Image-Segmentation.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Object-Detection"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Object Detection</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Point-Cloud-Segmentation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Perform Deep Learning Based Semantic Point Cloud Segmentation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#start-the-docker-environment" class="table-of-contents__link toc-highlight">Start the Docker Environment</a></li><li><a href="#download-and-inspect-bag-file" class="table-of-contents__link toc-highlight">Download and Inspect Bag file</a></li><li><a href="#ros2s-sensor_msgsmsgimage-message" class="table-of-contents__link toc-highlight">ROS2&#39;s <code>sensor_msgs/msg/Image</code> Message</a></li><li><a href="#ros2s-sensor_msgsmsgcamerainfo-message" class="table-of-contents__link toc-highlight">ROS2&#39;s <code>sensor_msgs/msg/CameraInfo</code> Message</a></li><li><a href="#build-and-source-the-package" class="table-of-contents__link toc-highlight">Build and source the package</a></li><li><a href="#replay-rosbag-and-run-image-segmentation" class="table-of-contents__link toc-highlight">Replay rosbag and run image segmentation</a></li><li><a href="#review-of-file-image_segmentationpy" class="table-of-contents__link toc-highlight">Review of file image_segmentation.py</a></li><li><a href="#task-1-implement-conversion-from-segmentation-map-to-rgb-encoding" class="table-of-contents__link toc-highlight">Task 1: Implement conversion from segmentation map to RGB encoding</a><ul><li><a href="#expected-output" class="table-of-contents__link toc-highlight">Expected output</a></li></ul></li><li><a href="#wrap-up" class="table-of-contents__link toc-highlight">Wrap-up</a></li><li><a href="#ros1-instructions" class="table-of-contents__link toc-highlight">ROS1 Instructions</a><ul><li><a href="#start-the-docker-environment-1" class="table-of-contents__link toc-highlight">Start the Docker Environment</a></li></ul></li><li><a href="#download-and-inspect-bag-file-1" class="table-of-contents__link toc-highlight">Download and Inspect Bag file</a></li><li><a href="#ros-sensor_msgsimage-message" class="table-of-contents__link toc-highlight">ROS&#39; <code>sensor_msgs/Image</code> Message</a></li><li><a href="#ros-sensor_msgscamerainfo" class="table-of-contents__link toc-highlight">ROS&#39; <code>sensor_msgs/CameraInfo</code></a></li><li><a href="#build-and-source-the-package-1" class="table-of-contents__link toc-highlight">Build and source the package</a></li><li><a href="#replay-rosbag-and-run-image-segmentation-1" class="table-of-contents__link toc-highlight">Replay rosbag and run image segmentation</a></li><li><a href="#review-of-file-image_segmentationpy-1" class="table-of-contents__link toc-highlight">Review of file image_segmentation.py</a></li><li><a href="#task-1-implement-conversion-from-segmentation-map-to-rgb-encoding-1" class="table-of-contents__link toc-highlight">Task 1: Implement conversion from segmentation map to RGB encoding</a></li><li><a href="#wrap-up-1" class="table-of-contents__link toc-highlight">Wrap-up</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Coding</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/cpp/getting_started">C++</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/python/getting_started">Python</a></li></ul></div><div class="col footer__col"><div class="footer__title">Robot Operating System</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros/getting_started">ROS</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros2/getting_started">ROS2</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/CagriCatik/Autonomous-Connected-Driving" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 - Automated and Connected Driving.</div></div></div></footer></div>
</body>
</html>