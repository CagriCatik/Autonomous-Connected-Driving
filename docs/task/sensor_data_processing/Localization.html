<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-task/sensor_data_processing/Localization" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Localization | Automated and Connected Driving</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Localization"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Localization | Automated and Connected Driving"><meta data-rh="true" name="description" content="Combining GNSS and LiDAR-Odometry for Frequent Pose Estimation"><meta data-rh="true" property="og:description" content="Combining GNSS and LiDAR-Odometry for Frequent Pose Estimation"><link data-rh="true" rel="icon" href="/Autonomous-Connected-Driving/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Localization"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Localization" hreflang="en"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Localization" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Autonomous-Connected-Driving/blog/rss.xml" title="Automated and Connected Driving RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Autonomous-Connected-Driving/blog/atom.xml" title="Automated and Connected Driving Atom Feed"><link rel="stylesheet" href="/Autonomous-Connected-Driving/assets/css/styles.ce2d5abf.css">
<script src="/Autonomous-Connected-Driving/assets/js/runtime~main.43a711df.js" defer="defer"></script>
<script src="/Autonomous-Connected-Driving/assets/js/main.575fec18.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Autonomous-Connected-Driving/"><div class="navbar__logo"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/introduction-tools/getting_started">Introduction &amp; Tools</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/sensor-data-processing/getting_started">Sensor Data Processing</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/object-fusion-tracking/getting_started">Object Fusion and Tracking</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/vehicle-guidance/getting_started">Vehicle Guidance</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/connected-driving/getting_started">Connected Driving</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Autonomous-Connected-Driving/docs/task/getting_started">Tasks</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/cpp/getting_started">C++</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/python/getting_started">Python</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros/getting_started">ROS</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros2/getting_started">ROS2</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Autonomous-Connected-Driving/docs/task/getting_started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/introduction--tools">Introduction &amp; Tools</a><button aria-label="Expand sidebar category &#x27;Introduction &amp; Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/Autonomous-Connected-Driving/docs/category/sensor-data-processing">Sensor Data Processing</a><button aria-label="Collapse sidebar category &#x27;Sensor Data Processing&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Camera-based-Semantic-Grid-Mapping">Camera-based Semantic Grid Mapping</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Deep-OGM">Deep Learning-based Point Cloud Occupancy Grid Mapping</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Geometric-OGM">Geometric Point Cloud Occupancy Grid Mapping</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Localization">Localization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Object-Detection">Object Detection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Image-Segmentation">Semantic Image Segmentation Applied on Camera Images</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Semantic-Point-Cloud-Segmentation">Perform Deep Learning Based Semantic Point Cloud Segmentation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/object-fusion-tracking">Object Fusion Tracking</a><button aria-label="Expand sidebar category &#x27;Object Fusion Tracking&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/vehicle-guidance">Vehicle Guidance</a><button aria-label="Expand sidebar category &#x27;Vehicle Guidance&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/connected-driving">Connected Driving</a><button aria-label="Expand sidebar category &#x27;Connected Driving&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Autonomous-Connected-Driving/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/Autonomous-Connected-Driving/docs/category/sensor-data-processing"><span itemprop="name">Sensor Data Processing</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Localization</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Localization</h1></header>
<p><strong>Combining GNSS and LiDAR-Odometry for Frequent Pose Estimation</strong></p>
<p>In this workshop, we will perform <strong>localization</strong> based on GNSS and LiDAR measurements. To achieve a high frequent pose estimate, we will fuse both sources of information.</p>
<p>We will use a recording from a simulation containing LiDAR point clouds, GNSS measurements and a corresponding ground-truth pose. To better understand the context of the vehicle&#x27;s environment, the recording also contains a stream of camera images.</p>
<p>The learning goals of this workshop are ...</p>
<ul>
<li>Set up a localization stack for automated driving in an urban environment using ROS 2</li>
<li>Utilize and investigate <a href="https://github.com/PRBonn/kiss-icp" target="_blank" rel="noopener noreferrer">KISS-ICP</a> LiDAR Odometry</li>
<li>Implement further processing of the lidar odometry output by combining it with low-frequent GNSS measurements</li>
<li>Apply projections and transformations to the GNSS measurements</li>
<li>Record a bag file for further investigations of the results in a separate <a href="https://github.com/ika-rwth-aachen/acdc-notebooks" target="_blank" rel="noopener noreferrer">Notebook Exercise</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-this-workshop">Introduction to this workshop<a href="#introduction-to-this-workshop" class="hash-link" aria-label="Direct link to Introduction to this workshop" title="Direct link to Introduction to this workshop">​</a></h2>
<p>We prepared a rosbag with measurement data captured in simulation for you to use.</p>
<p>Download the file <code>localization.db3</code> from <a href="https://rwth-aachen.sciebo.de/s/xThSPRBLxD8way6" target="_blank" rel="noopener noreferrer"><strong>here (1.2 GB)</strong></a>.</p>
<p>Save this file to your local directory <code>${REPOSITORY}/bag</code>. This directory will be mounted into the docker container to the path <code>/home/rosuser/ws/bag</code>.</p>
<p>After the download, navigate to the local directory <code>${REPOSITORY}/docker</code> on your host and execute <code>./ros2_run.sh</code> to start the ACDC docker container.</p>
<p>Inside the container, you can navigate to <code>/home/rosuser/ws/bag</code> and execute <code>ros2 bag info localization.db3</code> to inspect the rosbag:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Files:             localization.db3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bag size:          1.2 GiB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Storage id:        sqlite3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Duration:          117.463s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start:             Sep 26 2023 10:44:22.915 (1695717862.915)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">End:               Sep 26 2023 10:46:20.379 (1695717980.379)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Messages:          6051</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Topic information: Topic: /camera/image | Type: sensor_msgs/msg/Image | Count: 2375 | Serialization Format: cdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   Topic: /gnss/navsatfix | Type: sensor_msgs/msg/NavSatFix | Count: 114 | Serialization Format: cdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   Topic: /ground_truth/pose | Type: nav_msgs/msg/Odometry | Count: 2375 | Serialization Format: cdr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   Topic: /lidar/pointcloud | Type: sensor_msgs/msg/PointCloud2 | Count: 1187 | Serialization Format: cdr</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see that the rosbag has a duration of 117 seconds and contains 4 different messages:</p>
<ul>
<li>A <code>sensor_msgs/msg/Image</code> on topic <code>/camera/image</code> published with a frequency of 20 Hz. The purpose of the image stream is simply to get a better understanding of the environment the vehicle is moving in.</li>
<li>A <code>sensor_msgs/msg/NavSatFix</code> on topic <code>/gnss/navsatfix</code> published with a frequency of 1 Hz. This topic provides information of the vehicle position in a global reference frame.</li>
<li>A <code>nav_msgs/msg/Odometry</code> on topic <code>/ground_truth/pose</code> published with a frequency of 20 Hz. This topic is mainly utilized for debugging and evaluation purpose. Keep in mind, that it is really hard to gather ground-truth measurements for pose estimation in real-world. In this case since we captured this bag file using a simulation, we were able to easily derive the actual pose of the vehicle.</li>
<li>A <code>sensor_msgs/msg/PointCloud2</code> on topic <code>/lidar/pointcloud</code> published with a frequency of 10 Hz. This topic will be the input for LiDAR-Odometry.</li>
</ul>
<p>In the context of this course, the <code>nav_msgs/msg/Odometry</code> and the <code>sensor_msgs/msg/NavSatFix</code> will be new to you in particular. In the following, we will briefly discuss these two message types.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros-2s-nav_msgsmsgodometry-message">ROS 2&#x27;s <code>nav_msgs/msg/Odometry</code> Message<a href="#ros-2s-nav_msgsmsgodometry-message" class="hash-link" aria-label="Direct link to ros-2s-nav_msgsmsgodometry-message" title="Direct link to ros-2s-nav_msgsmsgodometry-message">​</a></h2>
<p>The message definition <a href="https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html" target="_blank" rel="noopener noreferrer">nav_msgs/msg/Odometry</a> is part of ROS 2&#x27;s standard messages. It is used for indicating an estimate of a robot&#x27;s (or in our case vehicle&#x27;s) pose and velocities in 3D space. Within this section, this message type is used for the ground truth pose of the vehicle, and for the output of the LiDAR-Odometry. Please read the documentation about the <a href="https://docs.ros2.org/latest/api/nav_msgs/msg/Odometry.html" target="_blank" rel="noopener noreferrer">detailed message format</a> and its content.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros-2s-sensor_msgsmsgnavsatfix-message">ROS 2&#x27;s <code>sensor_msgs/msg/NavSatFix</code> Message<a href="#ros-2s-sensor_msgsmsgnavsatfix-message" class="hash-link" aria-label="Direct link to ros-2s-sensor_msgsmsgnavsatfix-message" title="Direct link to ros-2s-sensor_msgsmsgnavsatfix-message">​</a></h2>
<p>The message definition <a href="https://docs.ros2.org/latest/api/sensor_msgs/msg/NavSatFix.html" target="_blank" rel="noopener noreferrer">sensor_msgs/msg/NavSatFix</a> is also part of ROS 2&#x27;s standard messages. It is designed to provide the position derived from any GNSS device. The resulting position is given with respect to the WGS84 system. Feel free to read the documentation about the <a href="https://docs.ros2.org/latest/api/sensor_msgs/msg/NavSatFix.html" target="_blank" rel="noopener noreferrer">detailed message format</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ros-2s-geometry_msgsmsgposestamped-message">ROS 2&#x27;s <code>geometry_msgs/msg/PoseStamped</code> Message<a href="#ros-2s-geometry_msgsmsgposestamped-message" class="hash-link" aria-label="Direct link to ros-2s-geometry_msgsmsgposestamped-message" title="Direct link to ros-2s-geometry_msgsmsgposestamped-message">​</a></h2>
<p>The message definition <a href="https://docs.ros2.org/latest/api/geometry_msgs/msg/PoseStamped.html" target="_blank" rel="noopener noreferrer">geometry_msgs/msg/PoseStamped</a> is also part of ROS 2&#x27;s standard messages. It is designed to provide the pose of a robot (or in our case a vehicle) in a cartestian coordinate system. The pose is composed of a <a href="https://docs.ros2.org/latest/api/geometry_msgs/msg/Point.html" target="_blank" rel="noopener noreferrer">geometry_msgs/msg/Point</a> providing the position and a <a href="https://docs.ros2.org/latest/api/geometry_msgs/msg/Quaternion.html" target="_blank" rel="noopener noreferrer">geometry_msgs/msg/Quaternion</a> providing the orientation. For further information on quaternions, please refer to the <a href="https://docs.ros.org/en/humble/Tutorials/Intermediate/Tf2/Quaternion-Fundamentals.html" target="_blank" rel="noopener noreferrer">ROS 2 tutorials</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="investigating-kiss-icp-lidar-odometry">Investigating KISS-ICP LiDAR Odometry<a href="#investigating-kiss-icp-lidar-odometry" class="hash-link" aria-label="Direct link to Investigating KISS-ICP LiDAR Odometry" title="Direct link to Investigating KISS-ICP LiDAR Odometry">​</a></h2>
<p>Now that we&#x27;ve investigated the bag-file, and you gained insights into some of the utilized message definitions, we&#x27;re ready to build and run some code.</p>
<p>As described above, we will combine GNSS measurements with the output of a LiDAR-Odometry approach to achieve a higher-frequent pose estimate for our vehicle.</p>
<p>Since there are many good implementations publicly available already, the wheel does not always have to be reinvented! In our case, we will use the LiDAR-Odometry pipeline <a href="https://github.com/PRBonn/kiss-icp" target="_blank" rel="noopener noreferrer">KISS-ICP</a> that is included as submodule (<code>colcon_workspace/section_2/localization/kiss-icp</code>) within our workspace.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-configuration-of-kiss-icp">Task 1: Configuration of KISS-ICP<a href="#task-1-configuration-of-kiss-icp" class="hash-link" aria-label="Direct link to Task 1: Configuration of KISS-ICP" title="Direct link to Task 1: Configuration of KISS-ICP">​</a></h3>
<p>We already prepared a launch file to start the lidar odometry within our workspace: <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/launch/odometry.launch.py" target="_blank" rel="noopener noreferrer"><code>colcon_workspace/section_2/localization/localization/launch/odometry.launch.py</code></a>.</p>
<p>Starting KISS-ICP LiDAR Odometry is as simple as remapping the input topic of the <code>sensor_msgs/msg/PointCloud2</code> message.
To achieve this, adjust the launch-file in <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/launch/odometry.launch.py#L41" target="_blank" rel="noopener noreferrer">line 41</a>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># START TASK 1 CODE HERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">remappings</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;pointcloud_topic&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/my_pcl_topic&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parameters</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;publish_alias_tf&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;publish_odom_tf&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;odom_frame&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;odom&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;child_frame&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ego_vehicle/lidar&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;max_range&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;min_range&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;deskew&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;max_points_per_voxel&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;initial_threshold&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;min_motion_th&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># END TASK 1 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Moreover, you can parameterize the KISS-ICP algorithm with various parameters. Feel free to vary the parameter values later on and observe the influence on the odometry result.
For now, you can leave the paremeter values as they are.</p>
<p>When you have successfully edited the launch file and saved your changes, you can navigate to <code>colcon_workspace</code> and build the package with <code>colcon build</code>. Make sure to perform these actions using a terminal window that is attached to your container.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization --symlink-install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we can launch the LiDAR-Odometry:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch localization odometry.launch.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RViz will open but you won&#x27;t be able to see anything happen. First, we need to play the bag file. To do so, please attach a new terminal to the docker container with <code>./ros2_run.sh</code> (if you haven&#x27;t already).</p>
<p>Again, navigate into the <code>colcon_workspace</code> and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate into the <code>bag</code> directory and play the bag-file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ../bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ros2 bag play localization.db3 --clock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If everything is configured correctly, the output in the RViz window should look like the following:</p>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/lidar_odometry_output-404dd1d4b2059bab6be3e10f8c0e87e7.png" width="1348" height="779" class="img_ev3q"></p>
<p>The image shows the accumulated pointclouds and the estimated vehicle trajectory (blue line) that is derived via scan-matching through the ICP algorithm.</p>
<p><strong>Investigating the resulting behavior</strong></p>
<p>Inspect the bag file until the end. Maybe you will notice something at the second half of the recording? Can you explain the resulting behavior? Maybe a look at the image stream will help you to explain it!</p>
<p>We&#x27;ll leave it at that for now since we&#x27;ve successfully launched the KISS-ICP. Feel free to invesitgate the influence of the various parameters on the resulting pose estimate.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="processing-of-gnss-measurements">Processing of GNSS measurements<a href="#processing-of-gnss-measurements" class="hash-link" aria-label="Direct link to Processing of GNSS measurements" title="Direct link to Processing of GNSS measurements">​</a></h2>
<p>In the following tasks, we will combine the output of LiDAR odometry with GNSS measurements to obtain a pose estimate that is as accurate and robust as possible.</p>
<p>The following tasks will all modify the source code of the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/src/GNSSLocalizationNode.cpp" target="_blank" rel="noopener noreferrer"><code>GNSSLocalizationNode.cpp</code></a>. First, we will investigate the processing of incoming GNSS measurements. For each incoming GNSS measurement the <code>gnssCallback</code> is called.</p>
<p>Usually, algorithms in an automated driving stack work with cartesian coordinate systems. On the other hand, a GNSS device usually delivers the position estimate with respect to the WGS84 reference system. For this reason, it is necessary to apply a projection from the spherical coordinates to a cartesian coordinate system. In our case, we will use the UTM reference system.</p>
<p>In the respective callback, the incoming message is initially projected to UTM coordinates by the function <code>projectToUTM</code>.
We will implement this function in <a href="#task-2-projecting-gnss-measurements-into-the-utm-reference-frame">Task 2</a>.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void GNSSLocalizationNode::gnssCallback(sensor_msgs::msg::NavSatFix::UniquePtr msg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  geometry_msgs::msg::PointStamped utm_point;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // apply projection to get utm position from the received WGS84 position</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!projectToUTM(msg-&gt;latitude, msg-&gt;longitude, utm_point)) return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  utm_point.header.stamp=msg-&gt;header.stamp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  geometry_msgs::msg::PointStamped map_point;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As already explained in theory, the UTM reference system divides the world into 60 zones. Furthermore, a distinction is made between northern and southern hemisphere. A position within a UTM zone can then be indicated by two values: <code>northing</code> and <code>easting</code> in meters. It is obvious that depending on where we are in the world these values can take large numerical values. For this reason, local coordinate systems are often used, which are defined relative to the UTM zone.</p>
<p>In our case, we&#x27;re using the <code>carla_map</code> frame which is shifted but not rotated relative to the coordinate system of the UTM zone. This allows us to work with smaller numerical values in the local vehicle environment. In practice, this local coordinate system can be defined, for example, by the segment of the digital map that is used in the vehicle environment.</p>
<p>The transformation from the UTM reference system into the <code>carla-map</code> frame is performed through the function <code>transformPoint</code>. We will implement this function in <a href="#task-3-transforming-an-utm-point-into-a-local-map-frame-using-tf2">Task 3</a>.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  // transform the utm-position into the carla_map-frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // the corresponding transform from utm to carla_map is provided by the tf_broadcaster_node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(!transformPoint(utm_point, map_point, &quot;carla_map&quot;)) return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // publish the gps point as message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  publisher_gnss_point_-&gt;publish(map_point);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Up to this point, we have only considered the <em>position</em> of the vehicle. In addition to the position, the knowledge of the <em>orientation</em> of the vehicle is also required. In this example, we will only consider the 2D pose. Since GNSS does not provide any information about the orientation of the vehicle per se, we will estimate the vehicle orientation from two sequential GNSS measurements in <a href="#task-4-estimating-the-vehicle-yaw-from-sequential-gnss-measurements">Task 4</a>. This is performed through the <code>estimateGNSSYawAngle</code> function.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  // Estimate the yaw angle from two GNSS-points within the map-frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(last_gnss_map_point_!=nullptr) // We need two GNSS-points to estimate the yaw angle --&gt; check if the last_gnss_map_point_ is available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    geometry_msgs::msg::PoseStamped map_pose;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    estimateGNSSYawAngle(map_point, *last_gnss_map_point_, map_pose);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // store the map_pose in a member variable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gnss_map_pose_ = std::make_shared&lt;geometry_msgs::msg::PoseStamped&gt;(map_pose);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publisher_gnss_pose_-&gt;publish(*gnss_map_pose_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new_gnss_pose_ = true; // flag indicating if a new gnss_pose is available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Set the current map_point to the last_gnss_map_point_ for the next iteration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_gnss_map_point_ = std::make_shared&lt;geometry_msgs::msg::PointStamped&gt;(map_point);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The callback also publishes various topics for visualization, so you can view the intermediate results in RViz.</p>
<p>Now that you have understood the basic processing steps for GNSS measurements, you can start with <a href="#task-2-projecting-gnss-measurements-into-the-utm-reference-frame">Task 2</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-2-projecting-gnss-measurements-into-the-utm-reference-frame">Task 2: Projecting GNSS measurements into the UTM reference frame<a href="#task-2-projecting-gnss-measurements-into-the-utm-reference-frame" class="hash-link" aria-label="Direct link to Task 2: Projecting GNSS measurements into the UTM reference frame" title="Direct link to Task 2: Projecting GNSS measurements into the UTM reference frame">​</a></h3>
<p>As described before, we will implement a function to project GNSS measurements provided with respect to the WGS84 system into the UTM reference system. Again, this is a problem for which we can use existing software libraries. In our case, we will use the <code>Geographiclib</code>.</p>
<p>Open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/src/GNSSLocalizationNode.cpp#L101" target="_blank" rel="noopener noreferrer">GNSSLocalizationNode.cpp at line 101</a> to implement the desired functionality.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief Get the UTM Position defined by the given latitude and longitude coordinates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The position is transformed into UTM by using GeographicLib::UTMUPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] latitude latitude coordinate in decimal degree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] longitude longitude coordinate in decimal degree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[out] geometry_msgs::msg::PointStamped indicating the position in the utm system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @return bool indicating if projection was successfull</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bool GNSSLocalizationNode::projectToUTM(const double&amp; latitude, const double&amp; longitude, geometry_msgs::msg::PointStamped&amp; utm_point)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // START TASK 2 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // return true if successful</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // END TASK 2 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (GeographicLib::GeographicErr&amp; e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RCLCPP_WARN_STREAM(this-&gt;get_logger(), &quot;Tranformation from WGS84 to UTM failed: &quot; &lt;&lt; e.what());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hints">Hints:<a href="#hints" class="hash-link" aria-label="Direct link to Hints:" title="Direct link to Hints:">​</a></h4>
<ul>
<li>Use the description in the comment above the function header to implement the corresponding functionality.</li>
<li>The class <code>GeographicLib::UTMUPS</code> offers the function <code>void GeographicLib::UTMUPS::</code><a href="https://geographiclib.sourceforge.io/2009-03/classGeographicLib_1_1UTMUPS.html#a208fc16b8d5adfc3faeae0c1f0f2b831" target="_blank" rel="noopener noreferrer"><code>Forward</code></a><code>(double lat, double lon, int&amp; zone, bool&amp; northp, double&amp; x, double&amp; y)</code>. The required arguments are given as follows:<!-- -->
<ul>
<li><code>double lat</code> [input] latitude coordinate</li>
<li><code>double lon</code> [input] longitude coordinate</li>
<li><code>int&amp; zone</code> [output] reference to an integer variable that indicates the corresponding UTM-zone</li>
<li><code>bool&amp; northp</code> [output] reference to a bool variable that indicates if the corresponding UTM-zone is located on the northern hemisphere or not</li>
<li><code>double&amp; x</code> [output] reference to a double variable that gives the resulting <code>easting</code> coordinate in the UTM-zone</li>
<li><code>double&amp; y</code> [output] reference to a double variable that gives the resulting <code>northing</code> coordinate in the UTM-zone</li>
</ul>
</li>
<li>The variables <code>zone</code> and <code>northp</code> need to be provided as arguments in <code>GeographicLib::UTMUPS::Forward</code>, but since they are not needed afterwards you can declare the corresponding variables in the local scope of the function. They do not have to be returned!</li>
<li>Change the <code>frame_id</code> from the variable <code>utm_point</code> to <code>utm</code> before returning the function, since the position is given relative to the UTM-frame.<!-- -->
<ul>
<li>you can access the <code>frame_id</code> variable by typing <code>utm_point.header.frame_id</code></li>
</ul>
</li>
<li>Make sure to return <code>true</code> if the projection was successful</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing:<a href="#testing" class="hash-link" aria-label="Direct link to Testing:" title="Direct link to Testing:">​</a></h4>
<p>If you are unsure about your implementation, you can run a simple unit test before proceeding to the next task.</p>
<p>First, make sure that the implemented code compiles without errors. Therefore, run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization --symlink-install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you do not get any compilation errors, open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/test/test_gnss_localization.cpp" target="_blank" rel="noopener noreferrer"><code>test_gnss_localization.cpp</code></a> file. The implemented test executes the test function for the WGS84 position <code>latitude = 50.787467</code> and <code>longitude = 6.046498</code>. In our case, we expect a value of <code>291827.02</code> for the UTM x-coordinate and <code>5630349.72</code> for the UTM y-coordinate. Furthermore, it is checked if the <code>frame_id</code> is set correctly and the return value of the function is <code>true</code>.</p>
<p>To test your implementation, simply paste your implementation into the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/test/test_gnss_localization.cpp#L20" target="_blank" rel="noopener noreferrer">test-function</a>, rebuild the code,</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>run the test</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon test --packages-up-to localization &amp;&amp; colcon test-result --verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and inspect the results:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[==========] Running 1 test from 1 test suite.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------] Global test environment set-up.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------] 1 test from TestGNSSLocalization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ RUN      ] TestGNSSLocalization.test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/docker-ros/ws/colcon_workspace/src/section_2/localization/localization/test/test_gnss_localization.cpp:38: Failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Expected equality of these values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  projectToUTM(latitude, longitude, utm_point)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Which is: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/docker-ros/ws/colcon_workspace/src/section_2/localization/localization/test/test_gnss_localization.cpp:39: Failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The difference between 291827.02 and utm_point.point.x is 291827.02000000002, which exceeds 1e-2, where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">291827.02 evaluates to 291827.02000000002,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">utm_point.point.x evaluates to 0, and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1e-2 evaluates to 0.01.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/docker-ros/ws/colcon_workspace/src/section_2/localization/localization/test/test_gnss_localization.cpp:40: Failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The difference between 5630349.72 and utm_point.point.y is 5630349.7199999997, which exceeds 1e-2, where</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5630349.72 evaluates to 5630349.7199999997,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">utm_point.point.y evaluates to 0, and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1e-2 evaluates to 0.01.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/docker-ros/ws/colcon_workspace/src/section_2/localization/localization/test/test_gnss_localization.cpp:41: Failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Expected equality of these values:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;utm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  utm_point.header.frame_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Which is: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  FAILED  ] TestGNSSLocalization.test (0 ms)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------] 1 test from TestGNSSLocalization (0 ms total)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[----------] Global test environment tear-down</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[==========] 1 test from 1 test suite ran. (0 ms total)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  PASSED  ] 0 tests.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  FAILED  ] 1 test, listed below:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  FAILED  ] TestGNSSLocalization.test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1 FAILED TEST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Above, you will find the output of the test result in case that no implementation has been made. The log of the test says that neither <code>utm_point.point.x</code> and <code>utm_point.point.y</code> are set correctly, because both have the value <code>0</code> after the function call. Furthermore, the <code>frame_id</code> of the <code>utm_point</code> is not set and the return-value of the function is still set to <code>false</code>.</p>
<p>If implemented correctly, the log of the test function should look like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Starting &gt;&gt;&gt; kiss_icp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished &lt;&lt;&lt; kiss_icp [0.02s]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting &gt;&gt;&gt; localization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Finished &lt;&lt;&lt; localization [0.10s]          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Summary: 2 packages finished [0.27s]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Summary: 2 tests, 0 errors, 0 failures, 0 skipped</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-3-transforming-an-utm-point-into-a-local-map-frame-using-tf2">Task 3: Transforming an UTM point into a local map frame using tf2<a href="#task-3-transforming-an-utm-point-into-a-local-map-frame-using-tf2" class="hash-link" aria-label="Direct link to Task 3: Transforming an UTM point into a local map frame using tf2" title="Direct link to Task 3: Transforming an UTM point into a local map frame using tf2">​</a></h3>
<p>Now that we have transformed the WGS84 position into the UTM coordinate system, we can perform another transformation into the local coordinate system <code>carla_map</code>. This is achieved by implementing the function <code>transformPoint</code>.</p>
<p>Open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/src/GNSSLocalizationNode.cpp#L126" target="_blank" rel="noopener noreferrer">GNSSLocalizationNode.cpp at line 126</a> to implement the desired functionality.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief This function transforms a given geometry_msgs::msg::PointStamped into a given frame if tf is available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] input_point </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[out] output_point </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] output_frame the frame to transform input_point to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @return bool indicating if transformation was successful</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bool GNSSLocalizationNode::transformPoint(const geometry_msgs::msg::PointStamped&amp; input_point, geometry_msgs::msg::PointStamped&amp; output_point, const std::string&amp; output_frame)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // START TASK 3 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // return true if successful</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // END TASK 3 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (tf2::TransformException&amp; ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RCLCPP_WARN_STREAM(this-&gt;get_logger(), &quot;Tranformation from &#x27;&quot; &lt;&lt; input_point.header.frame_id &lt;&lt; &quot;&#x27; to &#x27;&quot; &lt;&lt; output_frame &lt;&lt; &quot;&#x27; is not available!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hints-1">Hints:<a href="#hints-1" class="hash-link" aria-label="Direct link to Hints:" title="Direct link to Hints:">​</a></h4>
<ul>
<li>Use the description in the comment above the function header to implement the corresponding functionality.</li>
<li>Use tf2 to perform the transformation. Transformations with tf2 are usually performed in two steps:<!-- -->
<ol>
<li>retrieve the needed transformation with <a href="https://docs.ros2.org/latest/api/tf2_ros/classtf2__ros_1_1Buffer.html#a26f7be3af375e553b81188926dd38cc2" target="_blank" rel="noopener noreferrer"><code>lookupTransform</code></a>.</li>
<li>apply the transformation to a corresponding data type with <a href="https://docs.ros2.org/latest/api/tf2_geometry_msgs/namespacetf2.html#ac229f0979dd9a274d6e877d2b9469edb" target="_blank" rel="noopener noreferrer"><code>doTransform</code></a>.</li>
</ol>
</li>
<li><code>lookupTransform</code> is a member of <code>tf2_ros::Buffer</code>. The <code>GNSSLocalizationNode</code> has a member <code>std::unique_ptr&lt;tf2_ros::Buffer&gt;</code> called <code>tf_buffer_</code>. Thus you can call <code>lookupTransform</code> as follows: <code>tf_buffer_-&gt;lookupTransform(target_frame, source_frame, time)</code>
<ul>
<li>The <code>target_frame</code> is provided as function argument of <code>transformPoint</code></li>
<li>The <code>source_frame</code> can be derived from the <code>input_point</code> with <code>input_point.header.frame_id</code></li>
<li>Since we would like to lookup the transform matching the time of the measured <code>input_point</code> we pass the <code>input_point.header.stamp</code> as <code>time</code>-argument into <code>lookupTransform</code></li>
<li><code>lookupTransform</code> returns an object of type <code>geometry_msgs::msg::TransformStamped</code> that should be stored in a variable</li>
</ul>
</li>
<li><code>doTransform</code> is a public function in the <code>tf2</code>-namespace. Thus you can call <code>doTransform</code> as follows: <code>tf2::doTransform(input_point, output_point, transform)</code>
<ul>
<li>the input argument <code>transform</code> is of type <code>geometry_msgs::msg::TransformStamped</code> as returned from <code>lookupTransform</code></li>
</ul>
</li>
<li>The required transform from <code>utm</code> to <code>carla_map</code> is provided by the <code>tf_broadcaster_node</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="testing-1">Testing:<a href="#testing-1" class="hash-link" aria-label="Direct link to Testing:" title="Direct link to Testing:">​</a></h4>
<p>This time we will test the correct implementation by running the compiled ROS 2 node. First, make sure that the implemented code compiles without errors. There to run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After successful compilation source your workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and launch the localization-stack:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch localization localization.launch.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RViz will open but you won&#x27;t be able to see anything happen. First we need to play the bag file. To achieve this, please attach a new terminal to the docker container with <code>./ros2_run.sh</code> (if you haven&#x27;t already).</p>
<p>Again, navigate into the <code>colcon_workspace</code> and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate into the <code>bag</code> directory and play the bag-file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ../bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ros2 bag play localization.db3 --clock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If everything is implemented correctly, the output in the RViz window should look like the following:</p>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/localization_rviz-b9477b2f2b2350022c7b87468c132249.png" width="1922" height="1082" class="img_ev3q"></p>
<p>The red arrow in the RViz 3D-View visualizes the ground truth pose of the vehicle, while the purple sphere shows the corresponding transformed GNSS position of the vehicle. You will quickly notice that the GNSS position is published at a lower frequency compared to the ground-truth position, resulting in the visible position error in the image.</p>
<p>Before we can fuse the lower frequent GNSS measurements with information from odometry in order to obtain a suitable frequency, we first want to estimate a yaw angle from two sequential GNSS positions in <a href="#task-4-estimating-the-vehicle-yaw-from-sequential-gnss-measurements">Task 4</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-4-estimating-the-vehicle-yaw-from-sequential-gnss-measurements">Task 4: Estimating the vehicle yaw from sequential GNSS measurements<a href="#task-4-estimating-the-vehicle-yaw-from-sequential-gnss-measurements" class="hash-link" aria-label="Direct link to Task 4: Estimating the vehicle yaw from sequential GNSS measurements" title="Direct link to Task 4: Estimating the vehicle yaw from sequential GNSS measurements">​</a></h3>
<p>Within this task we would like to estimate the vehicle yaw-angle based on two sequential GNSS measurments.</p>
<p>The function you will implement requires two <code>geometry_msgs::msg::PointStamped</code> as input arguments and a <code>geometry_msgs::msg::PoseStamped</code> as output argument.
In the ROS 2 <code>geometry_msgs</code> definition, the orientation is given as a <a href="https://docs.ros.org/en/humble/Tutorials/Intermediate/Tf2/Quaternion-Fundamentals.html" target="_blank" rel="noopener noreferrer">quaternion</a>. First, you will calculate the yaw angle based on the two sequential points using trigonometric equations. Afterwards, you will have to convert this into a quaternion using <code>tf2</code>.</p>
<p>Open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/src/GNSSLocalizationNode.cpp#L147" target="_blank" rel="noopener noreferrer">GNSSLocalizationNode.cpp at line 147</a> to implement the desired functionality.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief This function estimates the yaw-angle of the vehicle with respect to two given point-measurements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] current_point the current GNSS Point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] last_point the previous GNSS Point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[out] output_pose geometry_msgs::msg::Pose including the current_point and an additional 2D orientation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void GNSSLocalizationNode::estimateGNSSYawAngle(const geometry_msgs::msg::PointStamped&amp; current_point, const geometry_msgs::msg::PointStamped&amp; last_point, geometry_msgs::msg::PoseStamped&amp; output_pose)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // START TASK 4 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // calculate the yaw angle from two sequential GNSS-points</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // use header from input point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // use the position provided through the input point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // generate a quaternion using the calculated yaw angle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // END TASK 4 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hints-2">Hints:<a href="#hints-2" class="hash-link" aria-label="Direct link to Hints:" title="Direct link to Hints:">​</a></h4>
<ul>
<li>Use the description in the comment above the function header to implement the corresponding functionality.</li>
<li>You may use the illustration below to derive the trigonometric equations to calculate the yaw angle</li>
<li>Use <a href="https://en.cppreference.com/w/cpp/numeric/math/atan2" target="_blank" rel="noopener noreferrer"><code>std::atan2</code></a> to calculate the arc tangent of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi><mi mathvariant="normal">/</mi><mi>d</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">dy/dx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span></span></span></span> since it automatically determines the correct quadrant.</li>
<li>Initialize a <code>tf2::Quaternion</code> object</li>
<li>The <code>tf2::Quaternion</code> class provides a function <code>setRPY(roll, pitch, yaw)</code> that generates a quaternion from the given <code>roll</code>, <code>pitch</code> and <code>yaw</code> arguments. The function needs to be called on an <code>tf2::Quaternion</code> object</li>
<li>For <code>roll</code> and <code>pitch</code> use a value of <code>0</code></li>
<li>Since the orientation in a <code>geometry_msgs::msg::PoseStamped</code> message is of type <code>geometry_msgs::msg::Quaternion</code>, we need to convert the <code>tf2::Quaternion</code> object into an <code>geometry_msgs::msg::Quaternion</code>. For this purpose, the <code>tf2_geometry_msgs</code> package offers the <code>tf2::toMsg(q)</code> which requires a <code>tf2::Quaternion</code> as function argument and returns the corresponding <code>geometry_msgs::msg::Quaternion</code>.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/yaw_estimation_illustration-c07c0b132261534c169d698edf407e9a.png" width="1479" height="838" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="testing-2">Testing:<a href="#testing-2" class="hash-link" aria-label="Direct link to Testing:" title="Direct link to Testing:">​</a></h4>
<p>Again, we will test the correct implementation by running the compiled ROS 2 node. First, make sure that the implemented code compiles without errors. For this purpose, please run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After successful compilation, source your workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and launch the localization-stack:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch localization localization.launch.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RViz will open but you won&#x27;t be able to see anything happen. First, we need to play the bag file. Please attach a new terminal to the docker container with <code>./ros2_run.sh</code> (if you haven&#x27;t already).</p>
<p>Again, navigate into the <code>colcon_workspace</code> and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate into the <code>bag</code> directory and play the bag file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ../bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ros2 bag play localization.db3 --clock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If everything is implemented correctly, the output in the RViz window should look like the following:</p>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/yaw_estimate_rviz-d0270dfa3cf38c1a613795e072b49338.png" width="1850" height="1055" class="img_ev3q"></p>
<p>Again, the red arrow in the RViz 3D-View visualizes the ground truth pose of the vehicle, while the purple sphere shows the corresponding transformed GNSS position of the vehicle. Now, in addition, you will see a purple arrow that indicates the estimated yaw angle of the vehicle.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="combining-odometry-and-gnss-measurements">Combining Odometry and GNSS measurements<a href="#combining-odometry-and-gnss-measurements" class="hash-link" aria-label="Direct link to Combining Odometry and GNSS measurements" title="Direct link to Combining Odometry and GNSS measurements">​</a></h2>
<p>Finally, we reached the point where we can combine the low-frequent GNSS measurements with the higher-frequent LiDAR-Odometry output.</p>
<p>This step is performed with every incoming LiDAR-Odometry measurement, thus we use the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/src/GNSSLocalizationNode.cpp#L168" target="_blank" rel="noopener noreferrer">corresponding callback</a> to implement the functionalities.</p>
<p>First of all, in each callback iteration, the current odometry measurement is stored within a local variable <code>current_odometry</code>. Then, it is checked whether a previous odometry measurement is already stored in <code>last_odometry</code>, since we need at least two sequential measurements to derive the incremental movement of the vehicle in between the time of these two measurements.</p>
<p>This incremental movement is derived by the function <code>getIncrementalMovement</code>. At a higher level, this function works as follows. Since the incoming measurements are related to a fixed frame <code>odom</code> defined by the LiDAR odometry node, it is not sufficient to return only the differences of translation and rotation. These differences must be transformed into the vehicle frame associated with the position of the vehicle at the time of the <code>last_odometry_</code>. To derive the incremental movement associated with the pose corresponding to <code>last odometry_</code>, the function internally uses the <code>tf2</code> functions.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief This callback is invoked when the subscriber receives an odometry message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] msg input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void GNSSLocalizationNode::odometryCallback(nav_msgs::msg::Odometry::UniquePtr msg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // store the incoming message in a local object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nav_msgs::msg::Odometry current_odometry = *msg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(last_odometry_!=nullptr &amp;&amp; gnss_map_pose_!=nullptr) // We need at least two odometry measurements and a GNSS estimate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // derive the incremental movement of the vehicle inbetween two odometry measurements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    geometry_msgs::msg::Vector3 delta_translation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tf2::Quaternion delta_rotation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(!getIncrementalMovement(current_odometry, *last_odometry_, delta_translation, delta_rotation)) return;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now that the incremental movement between two odometry measurements is given, we can define the initial pose that is utilized for predicting the current vehicle pose.
The function <code>setInitialPose</code> either sets the variable <code>pose</code> to the latest predicted pose that is stored within the variable <code>predicted_map_pose_</code>, or in case that a new GNSS measurement is available, the function sets <code>pose</code> to this GNSS measurement.</p>
<p>Afterwards, the function <code>posePrediction</code> is responsible to apply the incremental movement onto the initial <code>pose</code>. The content of this function will be implemented by yourself within <a href="#task-5-predicting-the-current-pose-using-relative-odometry-measurements">Task 5</a>.</p>
<p>After the prediction step is performed in <code>posePrediction</code>, the resulting <code>pose</code> estimate is published and stored in the member variable <code>predicted_map_pose_</code> for usage in the next iteration.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    geometry_msgs::msg::PoseStamped pose;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // get the initial pose either from GNSS or from the previous iteration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setInitialPose(pose);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // predict the corresponding vehicle pose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    posePrediction(pose, delta_translation, delta_rotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Set timestamp to current odometry stamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pose.header.stamp = current_odometry.header.stamp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Save predicted pose for next iteration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    predicted_map_pose_ = std::make_shared&lt;geometry_msgs::msg::PoseStamped&gt;(pose);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Publish predicted pose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publisher_predicted_pose_-&gt;publish(*predicted_map_pose_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Save the current odometry as &quot;last_odometry&quot; for next iteration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  last_odometry_ = std::make_shared&lt;nav_msgs::msg::Odometry&gt;(current_odometry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can now either go on to Task 5 or have a look into the described functions to understand their functionality in more detail.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-5-predicting-the-current-pose-using-relative-odometry-measurements">Task 5: Predicting the current pose using relative odometry measurements<a href="#task-5-predicting-the-current-pose-using-relative-odometry-measurements" class="hash-link" aria-label="Direct link to Task 5: Predicting the current pose using relative odometry measurements" title="Direct link to Task 5: Predicting the current pose using relative odometry measurements">​</a></h3>
<p>As described before, the goal of this task is to implement the content of the function <code>posePrediction</code> that is responsible for applying incremental movements onto the initial <code>pose</code> dereived either from a new GNSS measurement or the latest iteration of the prediction step.</p>
<p>The main implementation task for you is to transform the incremental translations into the map frame. Use the illustration below to solve the task.</p>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/map_transform_illustration-a7f3e7b3bb64fc0762b524717c2f7904.png" width="1881" height="1002" class="img_ev3q"></p>
<p>Referring to the illustration, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">dx&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">dy&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> correspond to the variables <code>delta_translation.x</code> and <code>delta_translation.y</code> which are a given input. What we&#x27;re actually interested in are <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">dx_{map}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>y</mi><mrow><mi>m</mi><mi>a</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">dy_{map}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span>. We can derive these variables using trigonometric equations. The yaw angle <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>ψ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\psi&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">ψ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> corresponds to the variable <code>yaw</code> that is provided by the function <code>getYawFromQuaternion</code> (see code below).</p>
<p>To solve the task, perform the following steps:</p>
<ol>
<li>Derive the angle <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span></li>
<li>Derive the angle <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.05278em">β</span></span></span></span></li>
<li>Derive <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">dx_{map}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>y</mi><mrow><mi>m</mi><mi>a</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">dy_{map}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span></li>
<li>Add <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">dx_{map}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi>y</mi><mrow><mi>m</mi><mi>a</mi><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">dy_{map}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em"></span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> to <code>pose.pose.position.x</code> and <code>pose.pose.position.y</code></li>
<li>Apply the <code>delta_rotation</code> to the <code>tf2::Quaternion</code> that represents the orientation of <code>pose</code> given as variable <code>orientation</code>. The multiplication of two quaternions represents two sequential rotations!</li>
<li>Use <code>tf2::toMsg</code> to convert the resulting <code>tf2::Quaternion</code> into a <code>geometry_msgs::msg::Quaternion</code> and store this into <code>pose.pose.orientation</code></li>
</ol>
<p>Now you&#x27;re prepared to open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/colcon_workspace/src/section_2/localization/localization/src/GNSSLocalizationNode.cpp#L252" target="_blank" rel="noopener noreferrer">GNSSLocalizationNode.cpp at line 252</a> to implement the desired functionality.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @brief this function performs the actual prediction of the vehicle pose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[out] pose the pose on that delta_translation and delta_rotation is applied</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] delta_translation the incremental translation of the vehicle (in vehicle coordinates)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @param[in] delta_rotation the incremental rotation of the vehicle (in vehicle coordinates)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void GNSSLocalizationNode::posePrediction(geometry_msgs::msg::PoseStamped&amp; pose, const geometry_msgs::msg::Vector3&amp; delta_translation, const tf2::Quaternion&amp; delta_rotation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // The delta values are given in a vehicle centered frame --&gt; we need to transform them into the map frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // First perform the transformation of the translation into map coordinates, by using the yaw of the vehicle in map coordinates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tf2::Quaternion orientation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tf2::fromMsg(pose.pose.orientation, orientation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double yaw;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  getYawFromQuaternion(yaw, orientation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // START TASK 5 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Apply dx and dy (in map coordinates) to the position</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Last apply delta orientation to the pose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // the multiplication of two quaternions represents two sequential rotations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // END TASK 5 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hints-3">Hints:<a href="#hints-3" class="hash-link" aria-label="Direct link to Hints:" title="Direct link to Hints:">​</a></h4>
<ul>
<li>Use the description in the comment above the function header to implement the corresponding functionality.</li>
<li>You may use the illustration below to derive the trigonometric equations to calculate the translations in the map-frame</li>
<li>You may use <a href="https://en.cppreference.com/w/cpp/numeric/math/atan2" target="_blank" rel="noopener noreferrer"><code>std::atan2</code></a>, <a href="https://en.cppreference.com/w/cpp/numeric/math/sin" target="_blank" rel="noopener noreferrer"><code>std::sin</code></a>, <a href="https://en.cppreference.com/w/cpp/numeric/math/cos" target="_blank" rel="noopener noreferrer"><code>std::cos</code></a>, <a href="https://en.cppreference.com/w/cpp/numeric/math/sqrt" target="_blank" rel="noopener noreferrer"><code>std::sqrt</code></a> and <a href="https://en.cppreference.com/w/cpp/numeric/math/pow" target="_blank" rel="noopener noreferrer"><code>std::pow</code></a></li>
<li>The multiplication of two quaternions represents two sequential rotations.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h2>
<p>If you finished the implementation of <a href="#task-5-predicting-the-current-pose-using-relative-odometry-measurements">Task 5</a>, you can test the implementation and inspect the final result by running the compiled ROS 2 node. Make sure that the implemented code compiles without errors. For this purpose, please run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After successful compilation, source your workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and launch the localization stack:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch localization localization.launch.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>RViz will open, but you won&#x27;t be able to see anything happen. First, we need to play the bag file. Please attach a new terminal to the docker container with <code>./ros2_run.sh</code> (if you haven&#x27;t already).</p>
<p>Again, navigate into the <code>colcon_workspace</code> and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate into the <code>bag</code> directory and play the bag file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ../bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ros2 bag play localization.db3 --clock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In our case, make sure to enable the visualization of the <code>Predicted Pose</code> in the <code>Displays</code> Section of the RViz window by checking the corresponding check box.</p>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/rviz_displays-d4249be0e7da7fbff02ee9724168ae92.png" width="419" height="564" class="img_ev3q"></p>
<p>If everything is implemented correctly, the output in the RViz window should somehow look like the following:</p>
<p><img decoding="async" loading="lazy" alt="fag1" src="/Autonomous-Connected-Driving/assets/images/rviz_final_result-551fa921b8d66a1a4230ee95089ef76a.png" width="1850" height="1055" class="img_ev3q"></p>
<p>Next to the red (ground truth) and purple arrow (estimated GNSS pose), you will now see a green arrow indicating the predicted pose of the vehicle that results from combining the GNSS estimate with the odometry input.</p>
<p>Congratulations! You have completed the C++ implementation and set up a simple localization stack for automated driving. In the following exercise, we want to evaluate your results in a Jupyter notebook exercise. For this purpose, be sure to record a bag file. The instructions for doing so can be found in the following section.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preparation-for-notebook-exercise">Preparation for Notebook Exercise<a href="#preparation-for-notebook-exercise" class="hash-link" aria-label="Direct link to Preparation for Notebook Exercise" title="Direct link to Preparation for Notebook Exercise">​</a></h2>
<p>Make sure that the implemented code compiles without errors. For this purpose, please run:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">colcon build --packages-up-to localization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After successful compilation source your workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and launch the localization stack:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ros2 launch localization localization.launch.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Attach a new terminal to the docker container with <code>./ros2_run.sh</code> (if you haven&#x27;t already). Again, navigate into the <code>colcon_workspace</code> and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate into the <code>bag</code> directory and start recording a new bag file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ../bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ros2 bag record -o localization_evaluation /ground_truth/pose /localization/predicted_pose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, play the bag file. Attach a third terminal to the docker container with <code>./ros2_run.sh</code> (if you haven&#x27;t already).</p>
<p>Again, navigate into the <code>colcon_workspace</code> and source the workspace</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source install/setup.bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate into the <code>bag</code> directory and play the bag file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Run from within the colcon_workspace directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd ../bag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ros2 bag play localization.db3 --clock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the playback of <code>localization.db3</code> has finished, cancel the recording of your evaluation bag file by typing <code>ctrl+c</code> in the corresponding terminal.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap-up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap-up" title="Direct link to Wrap-up">​</a></h2>
<ul>
<li>You learned how to set up a localization stack for automated driving in an urban environment using ROS 2</li>
<li>You utilized and investigated <a href="https://github.com/PRBonn/kiss-icp" target="_blank" rel="noopener noreferrer">KISS-ICP</a> LiDAR Odometry</li>
<li>You learned how to implement further processing of the lidar odometry output by combining it with low-frequent GNSS measurements</li>
<li>You learned how to apply projections and transformations to GNSS measurements</li>
<li>You have completed a simple example for combining GNSS and LiDAR-Odometry measurements for pose estimation of automated vehicles</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/task/02_sensor_data_processing/04_Localization.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Geometric-OGM"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Geometric Point Cloud Occupancy Grid Mapping</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Autonomous-Connected-Driving/docs/task/sensor_data_processing/Object-Detection"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Object Detection</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-to-this-workshop" class="table-of-contents__link toc-highlight">Introduction to this workshop</a></li><li><a href="#ros-2s-nav_msgsmsgodometry-message" class="table-of-contents__link toc-highlight">ROS 2&#39;s <code>nav_msgs/msg/Odometry</code> Message</a></li><li><a href="#ros-2s-sensor_msgsmsgnavsatfix-message" class="table-of-contents__link toc-highlight">ROS 2&#39;s <code>sensor_msgs/msg/NavSatFix</code> Message</a></li><li><a href="#ros-2s-geometry_msgsmsgposestamped-message" class="table-of-contents__link toc-highlight">ROS 2&#39;s <code>geometry_msgs/msg/PoseStamped</code> Message</a></li><li><a href="#investigating-kiss-icp-lidar-odometry" class="table-of-contents__link toc-highlight">Investigating KISS-ICP LiDAR Odometry</a><ul><li><a href="#task-1-configuration-of-kiss-icp" class="table-of-contents__link toc-highlight">Task 1: Configuration of KISS-ICP</a></li></ul></li><li><a href="#processing-of-gnss-measurements" class="table-of-contents__link toc-highlight">Processing of GNSS measurements</a><ul><li><a href="#task-2-projecting-gnss-measurements-into-the-utm-reference-frame" class="table-of-contents__link toc-highlight">Task 2: Projecting GNSS measurements into the UTM reference frame</a></li><li><a href="#task-3-transforming-an-utm-point-into-a-local-map-frame-using-tf2" class="table-of-contents__link toc-highlight">Task 3: Transforming an UTM point into a local map frame using tf2</a></li><li><a href="#task-4-estimating-the-vehicle-yaw-from-sequential-gnss-measurements" class="table-of-contents__link toc-highlight">Task 4: Estimating the vehicle yaw from sequential GNSS measurements</a></li></ul></li><li><a href="#combining-odometry-and-gnss-measurements" class="table-of-contents__link toc-highlight">Combining Odometry and GNSS measurements</a><ul><li><a href="#task-5-predicting-the-current-pose-using-relative-odometry-measurements" class="table-of-contents__link toc-highlight">Task 5: Predicting the current pose using relative odometry measurements</a></li></ul></li><li><a href="#result" class="table-of-contents__link toc-highlight">Result</a></li><li><a href="#preparation-for-notebook-exercise" class="table-of-contents__link toc-highlight">Preparation for Notebook Exercise</a></li><li><a href="#wrap-up" class="table-of-contents__link toc-highlight">Wrap-up</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Coding</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/cpp/content">C++</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/python/content">Python</a></li></ul></div><div class="col footer__col"><div class="footer__title">Robot Operating System</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros/content">ROS</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros2/content">ROS2</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/CagriCatik/Autonomous-Connected-Driving" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 - Automated and Connected Driving.</div></div></div></footer></div>
</body>
</html>