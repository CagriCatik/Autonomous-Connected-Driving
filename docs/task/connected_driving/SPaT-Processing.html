<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-task/connected_driving/SPaT-Processing" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">SPaT Processing | Automated and Connected Driving</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/connected_driving/SPaT-Processing"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SPaT Processing | Automated and Connected Driving"><meta data-rh="true" name="description" content="ROS1"><meta data-rh="true" property="og:description" content="ROS1"><link data-rh="true" rel="icon" href="/Autonomous-Connected-Driving/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/connected_driving/SPaT-Processing"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/connected_driving/SPaT-Processing" hreflang="en"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/connected_driving/SPaT-Processing" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Autonomous-Connected-Driving/blog/rss.xml" title="Automated and Connected Driving RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Autonomous-Connected-Driving/blog/atom.xml" title="Automated and Connected Driving Atom Feed"><link rel="stylesheet" href="/Autonomous-Connected-Driving/assets/css/styles.ce2d5abf.css">
<script src="/Autonomous-Connected-Driving/assets/js/runtime~main.8e08f18a.js" defer="defer"></script>
<script src="/Autonomous-Connected-Driving/assets/js/main.43a98e14.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Autonomous-Connected-Driving/"><div class="navbar__logo"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/introduction-tools/getting_started">Introduction &amp; Tools</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/sensor-data-processing/getting_started">Sensor Data Processing</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/object-fusion-tracking/getting_started">Object Fusion and Tracking</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/vehicle-guidance/getting_started">Vehicle Guidance</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/connected-driving/getting_started">Connected Driving</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Autonomous-Connected-Driving/docs/task/getting_started">Tasks</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/cpp/getting_started">C++</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/python/getting_started">Python</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros/getting_started">ROS</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros2/getting_started">ROS2</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Autonomous-Connected-Driving/docs/task/getting_started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/introduction--tools">Introduction &amp; Tools</a><button aria-label="Expand sidebar category &#x27;Introduction &amp; Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/sensor-data-processing">Sensor Data Processing</a><button aria-label="Expand sidebar category &#x27;Sensor Data Processing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/object-fusion-tracking">Object Fusion Tracking</a><button aria-label="Expand sidebar category &#x27;Object Fusion Tracking&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/vehicle-guidance">Vehicle Guidance</a><button aria-label="Expand sidebar category &#x27;Vehicle Guidance&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/Autonomous-Connected-Driving/docs/category/connected-driving">Connected Driving</a><button aria-label="Collapse sidebar category &#x27;Connected Driving&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/connected_driving/Cloud-Based-Object-Fusion">Cloud Based Object Fusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/connected_driving/SPaT-Processing">SPaT Processing</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Autonomous-Connected-Driving/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/Autonomous-Connected-Driving/docs/category/connected-driving"><span itemprop="name">Connected Driving</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SPaT Processing</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SPaT Processing</h1></header>
<p><img decoding="async" loading="lazy" src="https://img.shields.io/badge/ROS1-blue" alt="ROS1" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spatmap-processing-for-trajectory-planning">SPaT/MAP processing for trajectory planning<a href="#spatmap-processing-for-trajectory-planning" class="hash-link" aria-label="Direct link to SPaT/MAP processing for trajectory planning" title="Direct link to SPaT/MAP processing for trajectory planning">​</a></h2>
<p>In contrast to the previous subsection, where your computer acted as a cloud and implemented a collective function, in the following tasks you will implement a supportive function that allows the trajectory planning to handle traffic lights.</p>
<p>For this purpose, we have added a pedestrian traffic light to the ika test track known from the previous sections. The main goal of this task is to visualize the SPaT/MAP data and adapt the trajectory planning from Section 4 so that it can react to the traffic light.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-configure-the-bridge-so-that-you-receive-the-messages-spatemmapem-from-the-traffic-light">Task 1: Configure the bridge so that you receive the messages (SPATEM/MAPEM) from the traffic light<a href="#task-1-configure-the-bridge-so-that-you-receive-the-messages-spatemmapem-from-the-traffic-light" class="hash-link" aria-label="Direct link to Task 1: Configure the bridge so that you receive the messages (SPATEM/MAPEM) from the traffic light" title="Direct link to Task 1: Configure the bridge so that you receive the messages (SPATEM/MAPEM) from the traffic light">​</a></h2>
<p>If not already done, you should first build your workspace.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">catkin build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source devel/setup.bash # make sure to execute this line in each of the following terminals!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The connected traffic light publishs its state and the corresponding intersection topology as SPATEM resp. MAPEM via MQTT to the broker from the last subsection. The ASN.1 decoding has already been done on the server, so the messages are in the following formats:</p>
<ul>
<li>SPATEM: <code>v2x_SPAT</code></li>
<li>MAPEM: <code>v2x_MAP</code></li>
</ul>
<p>You can take a closer look at all ROS message formats in this <a href="https://github.com/ika-rwth-aachen/acdc/tree/main/catkin_workspace/src/dependencies/definitions/msg" target="_blank" rel="noopener noreferrer">folder</a>.</p>
<p>To receive the messages you have to use the <strong>mqtt_client</strong>, which you should know from the last subsection.
Analogous to the <a href="https://github.com/ika-rwth-aachen/acdc/wiki/Section-5-Cloud-Based-Object-Fusion#task-1-configure-the-bridge-so-that-you-receive-the-two-object-lists" target="_blank" rel="noopener noreferrer">procedure</a> described there, you have to create a new configuration or extend your existing one accordingly. Use the following information for setting the parameters:</p>
<ul>
<li>the broker runs on a public server with this address <code>broker.hivemq.com</code></li>
<li>you don&#x27;t need any credentials to connect to the broker</li>
<li>you can subscribe to the messages on the following topics:<!-- -->
<ul>
<li>Signal Phase and Timing Message (SPATEM): <code>ika_acdc_22/SPATEM</code></li>
<li>MAP Message (MAPEM): <code>ika_acdc_22/MAPEM</code></li>
</ul>
</li>
</ul>
<p>If you are done with that, you can start your launch file by:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch mqtt_launchpack ${YourLaunchFile}.launch # make sure you have included the right parameter file</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If everything was done correctly, the node should have started with the information <code>Connected to broker at &#x27;tcp://broker.hivemq.com:1883&#x27;</code>. Afterwards you can check with <code>rqt</code> if the messages arrive on the ROS topics you have chosen.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-2-visualize-the-messages-spatemmapem-in-rviz">Task 2: Visualize the messages (SPATEM/MAPEM) in RVIZ<a href="#task-2-visualize-the-messages-spatemmapem-in-rviz" class="hash-link" aria-label="Direct link to Task 2: Visualize the messages (SPATEM/MAPEM) in RVIZ" title="Direct link to Task 2: Visualize the messages (SPATEM/MAPEM) in RVIZ">​</a></h2>
<p>We have already prepared the nodes in the section 4 &amp; section 5 folder, so you only have to implement the relevant parts.</p>
<p>To visualize the messages, you must first configure the <code>etsi_visualization</code> node with your chosen SPATEM/MAPEM ROS topic. You can set the necessary parameters in <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/launch/start_ETSIViz.launch#L4" target="_blank" rel="noopener noreferrer">start_ETSIViz.launch</a>.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mapem-visualization">MAPEM visualization<a href="#mapem-visualization" class="hash-link" aria-label="Direct link to MAPEM visualization" title="Direct link to MAPEM visualization">​</a></h3>
<p>Now we want to start visualizing our received MAP messages. Therefore you have to fill the gap at <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/src/MAPViz.cpp#L29" target="_blank" rel="noopener noreferrer">Line 29 in MAPViz.cpp</a>.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Identify number of intersections in message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int n_intersections = 0; // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ### END CODE HERE ###</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don&#x27;t know exactly how a MAPEM is structured, it&#x27;s best to look at the <a href="https://github.com/ika-rwth-aachen/acdc/tree/main/catkin_workspace/src/dependencies/definitions/msg/v2x_MAP.msg" target="_blank" rel="noopener noreferrer">definitions</a> or the <a href="https://www.etsi.org/deliver/etsi_ts/103300_103399/103301/01.03.01_60/ts_103301v010301p.pdf" target="_blank" rel="noopener noreferrer">ETSI standard</a>.</p>
<p>If you are done with that, you can rebuild your workspace and start the predefined V2X launchfile for the trajectory planner. It already includes the launchfile for the ETSI visualization.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">catkin build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch trajectory_planner vehicle_guidance_v2x.launch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If everything works correctly, the visualization will look like this:</p>
<p><img decoding="async" loading="lazy" alt="spat_empty" src="/Autonomous-Connected-Driving/assets/images/spat_empty-2e08c0a306cbcfdd5db21067270752ef.png" width="1293" height="688" class="img_ev3q"></p>
<p>As you can see, the visualization has been extended with some markers for the MAPEM. The position of the traffic lights are shown by the circle markers, which are currently displayed in black, because you have not interpreted the SPaT message yet. The trajectory planner also still acts as in Section 4 and is not influenced by the traffic lights.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spatem-visualization">SPATEM visualization<a href="#spatem-visualization" class="hash-link" aria-label="Direct link to SPATEM visualization" title="Direct link to SPATEM visualization">​</a></h3>
<p>Now you will face the SPaT message. Therefore you have to fill the <code>SignalGroup</code> struct with the information from the received SPAT messages.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct SignalGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint8_t sg_id; // signal group id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint8_t current_state; // current state of signal group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint16_t next_change; // time for next signal state change (timing_likelyTime)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Fill in the correct solution for the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/src/SPATViz.cpp#L57" target="_blank" rel="noopener noreferrer">marked lines in SPATViz.cpp</a>. You can use the expression for the <code>current_state</code> as an example.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sg.current_state = spat_intsctn.states[m].state_time_speed[0].eventState; // Get first element of state_time_speed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sg.sg_id = 0; // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sg.next_change = 0; // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ### END CODE HERE ###</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don&#x27;t know exactly how a SPATEM is structured, it&#x27;s best to look at the <a href="https://github.com/ika-rwth-aachen/acdc/tree/main/catkin_workspace/src/dependencies/definitions/msg/v2x_SPAT.msg" target="_blank" rel="noopener noreferrer">definitions</a> or the <a href="https://www.etsi.org/deliver/etsi_ts/103300_103399/103301/01.03.01_60/ts_103301v010301p.pdf" target="_blank" rel="noopener noreferrer">ETSI standard</a>.</p>
<p>After that you also have to visualize the current state of the traffic light in place of the black circles. Therefore, solve the task at the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/src/SPATViz.cpp#L129" target="_blank" rel="noopener noreferrer">other marked lines in SPATViz.cpp</a>. If you don&#x27;t know exactly which values the state of a signal group can take, have a look at the last video.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Set marker color depending on signal group state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// The signal group state is given by the function variable &quot;state&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">marker.color.r = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">marker.color.g = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">marker.color.b = 0.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ### END CODE HERE ###</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Afterwards you have to rebuild the workspace and restart the trajectory planner.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">catkin build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch trajectory_planner vehicle_guidance_v2x.launch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the implementation is successful, the visualization should show the same states for the four lanes and the opposite states for the two pedestrian directions as well as a timer with the time until the next signal change. For example like this:</p>
<p><img decoding="async" loading="lazy" alt="spat_filled" src="/Autonomous-Connected-Driving/assets/images/spat_filled-fb93c2c60d737897b98dfda8ddb6838d.png" width="1343" height="679" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-3-modify-the-trajectory-planner-so-it-can-react-to-the-traffic-lights">Task 3: Modify the trajectory planner, so it can react to the traffic lights<a href="#task-3-modify-the-trajectory-planner-so-it-can-react-to-the-traffic-lights" class="hash-link" aria-label="Direct link to Task 3: Modify the trajectory planner, so it can react to the traffic lights" title="Direct link to Task 3: Modify the trajectory planner, so it can react to the traffic lights">​</a></h2>
<p>Now that MAPEM and SPATEM of the traffic light have been visualized, you have to let the trajectory planner know how to react to it. For this, you have again to adjust the topics for the messages in <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_planner/launch/vehicle_guidance_v2x.launch#L59" target="_blank" rel="noopener noreferrer">vehicle_guidance_v2x.launch</a>.</p>
<p>After that, you have to interpret the messages in their related subscribers. For that, open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_planner/src/v2x_planner_interface.cpp" target="_blank" rel="noopener noreferrer">v2x_planner_interface.cpp</a> and fill in the marked gaps. Thereby you can use the implementations from the <code>etsi_visualization</code> as a reference. In sum, you have to transfer the received messages into a traffic light struct which is built like this:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct TrafficLight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int stationID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std::vector&lt;geometry_msgs::Point&gt; ingress_lane;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int sig_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int tl_id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool red;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ros::Time last_spat;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="process-mapem">Process MAPEM<a href="#process-mapem" class="hash-link" aria-label="Direct link to Process MAPEM" title="Direct link to Process MAPEM">​</a></h3>
<p>At best, start this task with the MAPEM callback function. With the help of the MAPEM, you can get information about the <code>ingress_lane</code>, <code>sig_id</code> and <code>tl_id</code>. This is important so that the vehicle knows where the traffic lights are and to which lane(s) they refer. So open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_planner/src/v2x_planner_interface.cpp#L73" target="_blank" rel="noopener noreferrer">v2x_planner_interface.cpp at line 73</a> and fill the two gaps.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Identify number of intersections in message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int n_intersections = 0; // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ### END CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Loop all intersections in message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for(int i = 0; i &lt; n_intersections; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  definitions::v2x_MAP_Intersection intsctn = msg.intersections[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Loop all lanes to get signal groups and traffic light positions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for(int m = 0; m &lt; intsctn.adjacent_lanes.size(); m++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    definitions::v2x_MAP_Lane lane = intsctn.adjacent_lanes[m];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // only ingress lanes can consider traffic signals -&gt; skip all egress lanes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bool is_egress_lane = true; // Task          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (is_egress_lane){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ### END CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After solving this first part of the task (and rebuilding the workspace), the vehicle should always stop before the traffic light, but not start again.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="process-spatem">Process SPATEM<a href="#process-spatem" class="hash-link" aria-label="Direct link to Process SPATEM" title="Direct link to Process SPATEM">​</a></h3>
<p>The final part of this task is to also interpret the SPaT messages so that the vehicle will move on again. Therefore open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_planner/src/v2x_planner_interface.cpp#L41" target="_blank" rel="noopener noreferrer">v2x_planner_interface.cpp at line 41</a> and fill the last two gaps.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Identify number of intersections in message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int n_intersections = 0; // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ### END CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Loop all intersections in message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for(int i = 0; i &lt; n_intersections; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  definitions::v2x_SPAT_IntersectionState spat_intsctn = msg.spatData_intersections[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Loop all movement states to get signal groups</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for(int m = 0; m &lt; spat_intsctn.states.size(); m++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Loop all traffic lights stored in the map data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(int k = 0; k&lt;trafficlights.size(); k++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if(trafficlights[k].stationID == msg.header_stationID &amp;&amp; trafficlights[k].sig_id == spat_intsctn.states[m].signalGroup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trafficlights[k].last_spat = ros::Time::now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ### START CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Check if signal state is red or not (hint: use an if condition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trafficlights[k].red = true; // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ### END CODE HERE ###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Remember: If you have problems with the implementation, you can use the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/src/SPATViz.cpp#L27" target="_blank" rel="noopener noreferrer">SPATEM</a>/<a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/src/MAPViz.cpp#L25" target="_blank" rel="noopener noreferrer">MAPEM subscriber</a> from the spat visualization as a reference. You can also look again in the last video how a SPATEM is defined, or look at the received SPATEM/MAPEM in <code>rqt</code>.</p>
<hr>
<p>When you are ready with your implementation, save your code rebuild the workspace and start the trajectory planner:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">catkin build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch trajectory_planner vehicle_guidance_v2x.launch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The trajectory planner should now react correctly to the traffic lights! The visualization will look something like this:</p>
<p><img decoding="async" loading="lazy" alt="trajectory_planner_v2x" src="/Autonomous-Connected-Driving/assets/images/tp_spat_map-9c292fed661a8e3a806655984ea6a093.gif" width="1398" height="464" class="img_ev3q"></p>
<p>If you notice incorrect behavior of the trajectory planner, feel free to adjust the weights of the cost terms and see how the behavior changes. This will let you change the parameterization during the simulation:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rosrun rqt_reconfigure rqt_reconfigure</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="dyn_reconfigure" src="/Autonomous-Connected-Driving/assets/images/sec6_dyn_reconfi-81bd3cdf3b539686eb0ce8961feb7591.png" width="1850" height="1055" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-4-visualize-other-vehicles-via-cooperative-awareness-messages-cam">Task 4: Visualize other vehicles via Cooperative Awareness Messages (CAM)<a href="#task-4-visualize-other-vehicles-via-cooperative-awareness-messages-cam" class="hash-link" aria-label="Direct link to Task 4: Visualize other vehicles via Cooperative Awareness Messages (CAM)" title="Direct link to Task 4: Visualize other vehicles via Cooperative Awareness Messages (CAM)">​</a></h2>
<p>In this last task of this workshop, we will focus on the Cooperative Awareness Message (CAM). Therefore you have to know that, using <code>vehicle_guidance_v2x.launch</code>, you already start the node which publishes your live position as CAM to the known MQTT broker when driving on the ika test track (<a href="https://github.com/ika-rwth-aachen/acdc/tree/main/catkin_workspace/src/workshops/section_5/etsi_message_generation" target="_blank" rel="noopener noreferrer">etsi_message_generation</a>). Your task will now be to visualize the CAMs of other students (their live position) in RVIZ.
Since we also have a simulation running permanently and therefore also send a CAM to the broker, you should always see at least one other vehicle on the track - if implemented correctly.</p>
<p>First you have to make sure that you receive the CAMs of the others. For this, extend the <code>mqtt_client</code> configuration from <a href="#task-1-configure-the-bridge-so-that-you-receive-the-messages-spatemmapem-from-the-traffic-light">Task 1</a>. You can subscribe to the messages on the following MQTT topic:</p>
<ul>
<li><code>ika_acdc_22/CAM</code>
Set <code>/CAM</code> as corresponding ROS topic. You can also chose another one, but then note that you also have to change it in the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/launch/start_ETSIViz.launch#L4" target="_blank" rel="noopener noreferrer">start_ETSIViz.launch</a> accordingly.</li>
</ul>
<p>Now start your launchfile from <a href="#task-1-configure-the-bridge-so-that-you-receive-the-messages-spatemmapem-from-the-traffic-light">Task 1</a> with the extended configuration and check in <code>rqt</code> if there are any messages on the CAM ROS topic.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch mqtt_launchpack ${YourLaunchFile}.launch # make sure you have included the right parameter file</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If this is the case, these messages must now be interpreted. For this you have to fill the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_5/etsi_visualization/src/ETSIViz.cpp#L84" target="_blank" rel="noopener noreferrer">marked code lines in ETSIViz.cpp</a> with the content from the received CAMs.</p>
<p>Note: The velocity is only given absolutely in the CAM, but must be split into x and y direction for our object definition. Use trigonometric functions for this. The following picture will help you.</p>
<p><img decoding="async" loading="lazy" alt="task4_velocity" src="/Autonomous-Connected-Driving/assets/images/task4_velocity-3eb311dc552413a302783bca6eafe649.png" width="801" height="536" class="img_ev3q"></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ### START CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// fill with information from message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj.IdInternal = 0; // stationID               // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float lon = 0;      // longitude (x)           // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float lat = 0;      // latitude (y)            // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float v_x = 0;      // velocity in x direction // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">float v_y = 0;      // velocity in y direction // Task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ### END CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don&#x27;t know exactly how a CAM is structured, it&#x27;s best to look at the <a href="https://github.com/ika-rwth-aachen/acdc/tree/main/catkin_workspace/src/dependencies/definitions/msg/v2x_CAM.msg" target="_blank" rel="noopener noreferrer">definitions</a> or the <a href="https://www.etsi.org/deliver/etsi_en/302600_302699/30263702/01.04.01_60/en_30263702v010401p.pdf" target="_blank" rel="noopener noreferrer">ETSI standard</a>.</p>
<p>If everything was implemented correctly, you should now always see at least one other vehicle including its speed vector (light blue) driving on the track. The more students are driving on the track at the same time, the more vehicles you will see!</p>
<p>Note: The CAMs are only visualized, the trajectory planner does not react to the other vehicles.</p>
<p>Your visualization could look like this, for example:</p>
<p><img decoding="async" loading="lazy" alt="tp_with_cam" src="/Autonomous-Connected-Driving/assets/images/tp_with_cam-425b6ebd3b4f999de9b260157863bbb4.gif" width="640" height="360" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap-up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap-up" title="Direct link to Wrap-up">​</a></h2>
<p>In this workshop you learned...</p>
<ul>
<li>how to interpret different ETSI messages.<!-- -->
<ul>
<li>SPAT</li>
<li>MAPEM</li>
<li>CAM</li>
</ul>
</li>
<li>how to use these messages to improve the trajectory planner from section 4.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="https://github.com/ika-rwth-aachen/mqtt_client" target="_blank" rel="noopener noreferrer">mqtt_client</a></li>
<li><a href="https://broker.hivemq.com/" target="_blank" rel="noopener noreferrer">broker.hivemq.com</a></li>
<li><a href="https://www.etsi.org/committee/its" target="_blank" rel="noopener noreferrer">ETSI standards</a></li>
<li><a href="https://www.ros.org" target="_blank" rel="noopener noreferrer">ROS</a></li>
<li><a href="https://github.com/avidbots/flatland" target="_blank" rel="noopener noreferrer">Flatland</a></li>
<li><a href="/Autonomous-Connected-Driving/docs/task/connected_driving/s">Control Toolbox</a></li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@article{adrlCT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  title={The control toolbox — An open-source C++ library for robotics, optimal and model predictive control},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author={Markus Giftthaler and Michael Neunert and Markus St{\&quot;a}uble and Jonas Buchli},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  journal={2018 IEEE International Conference on Simulation, Modeling, and Programming for Autonomous Robots (SIMPAR)},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  year={2018},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pages={123-129}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/task/05_connected_driving/02_SPaT-Processing.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Autonomous-Connected-Driving/docs/task/connected_driving/Cloud-Based-Object-Fusion"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cloud Based Object Fusion</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spatmap-processing-for-trajectory-planning" class="table-of-contents__link toc-highlight">SPaT/MAP processing for trajectory planning</a></li><li><a href="#task-1-configure-the-bridge-so-that-you-receive-the-messages-spatemmapem-from-the-traffic-light" class="table-of-contents__link toc-highlight">Task 1: Configure the bridge so that you receive the messages (SPATEM/MAPEM) from the traffic light</a></li><li><a href="#task-2-visualize-the-messages-spatemmapem-in-rviz" class="table-of-contents__link toc-highlight">Task 2: Visualize the messages (SPATEM/MAPEM) in RVIZ</a><ul><li><a href="#mapem-visualization" class="table-of-contents__link toc-highlight">MAPEM visualization</a></li><li><a href="#spatem-visualization" class="table-of-contents__link toc-highlight">SPATEM visualization</a></li></ul></li><li><a href="#task-3-modify-the-trajectory-planner-so-it-can-react-to-the-traffic-lights" class="table-of-contents__link toc-highlight">Task 3: Modify the trajectory planner, so it can react to the traffic lights</a><ul><li><a href="#process-mapem" class="table-of-contents__link toc-highlight">Process MAPEM</a></li><li><a href="#process-spatem" class="table-of-contents__link toc-highlight">Process SPATEM</a></li></ul></li><li><a href="#task-4-visualize-other-vehicles-via-cooperative-awareness-messages-cam" class="table-of-contents__link toc-highlight">Task 4: Visualize other vehicles via Cooperative Awareness Messages (CAM)</a></li><li><a href="#wrap-up" class="table-of-contents__link toc-highlight">Wrap-up</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Coding</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/cpp/content">C++</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/python/content">Python</a></li></ul></div><div class="col footer__col"><div class="footer__title">Robot Operating System</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros/content">ROS</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros2/content">ROS2</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/CagriCatik/Autonomous-Connected-Driving" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 - Automated and Connected Driving.</div></div></div></footer></div>
</body>
</html>