<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-task/vehicle_guidance/Trajectory-Control" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Trajectory Control | Automated and Connected Driving</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://cagricatik.github.io/Autonomous-Connected-Driving/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Control"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Trajectory Control | Automated and Connected Driving"><meta data-rh="true" name="description" content="ROS1"><meta data-rh="true" property="og:description" content="ROS1"><link data-rh="true" rel="icon" href="/Autonomous-Connected-Driving/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Control"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Control" hreflang="en"><link data-rh="true" rel="alternate" href="https://cagricatik.github.io/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Control" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/Autonomous-Connected-Driving/blog/rss.xml" title="Automated and Connected Driving RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Autonomous-Connected-Driving/blog/atom.xml" title="Automated and Connected Driving Atom Feed"><link rel="stylesheet" href="/Autonomous-Connected-Driving/assets/css/styles.ce2d5abf.css">
<script src="/Autonomous-Connected-Driving/assets/js/runtime~main.bd96b12b.js" defer="defer"></script>
<script src="/Autonomous-Connected-Driving/assets/js/main.43a98e14.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Autonomous-Connected-Driving/"><div class="navbar__logo"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Autonomous-Connected-Driving/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/introduction-tools/getting_started">Introduction &amp; Tools</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/sensor-data-processing/getting_started">Sensor Data Processing</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/object-fusion-tracking/getting_started">Object Fusion and Tracking</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/vehicle-guidance/getting_started">Vehicle Guidance</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/theory/connected-driving/getting_started">Connected Driving</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Autonomous-Connected-Driving/docs/task/getting_started">Tasks</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/cpp/getting_started">C++</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/python/getting_started">Python</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros/getting_started">ROS</a><a class="navbar__item navbar__link" href="/Autonomous-Connected-Driving/docs/ros2/getting_started">ROS2</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Autonomous-Connected-Driving/docs/task/getting_started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/introduction--tools">Introduction &amp; Tools</a><button aria-label="Expand sidebar category &#x27;Introduction &amp; Tools&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/sensor-data-processing">Sensor Data Processing</a><button aria-label="Expand sidebar category &#x27;Sensor Data Processing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/object-fusion-tracking">Object Fusion Tracking</a><button aria-label="Expand sidebar category &#x27;Object Fusion Tracking&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/Autonomous-Connected-Driving/docs/category/vehicle-guidance">Vehicle Guidance</a><button aria-label="Collapse sidebar category &#x27;Vehicle Guidance&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Control">Trajectory Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Planning">Trajectory Planning</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/Autonomous-Connected-Driving/docs/category/connected-driving">Connected Driving</a><button aria-label="Expand sidebar category &#x27;Connected Driving&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/Autonomous-Connected-Driving/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/Autonomous-Connected-Driving/docs/category/vehicle-guidance"><span itemprop="name">Vehicle Guidance</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Trajectory Control</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Trajectory Control</h1></header>
<p><img decoding="async" loading="lazy" src="https://img.shields.io/badge/ROS1-blue" alt="ROS1" class="img_ev3q"></p>
<p>In the previous workshop you may have noticed that the vehicle sometimes slowly deviates from the planned trajectory. If the deviation to the trajectory gets too large, the trajectory jumps into the center of the rear axis. This behaviour is due to the fact that the vehicle guidance system is implemented using the concept of Bi-Level-Stabilization. However, <strong>the low-level stabilization controller was not yet implemented in the previous workshop</strong>. Therefore, the vehicle was not able to correctly follow the trajectory given by the high-level stabilization of the trajectory planner. When the deviation became too large, the MPC was reinitialized with the current measured vehicle data - hence the jump back to the center of the rear axis.</p>
<p>The learning goals of this workshop are...</p>
<ul>
<li>learn to implement the odometry equations to calculate the lateral and heading deviation of the vehicle to the trajectory.</li>
<li>calculate the control deviations using target values given by the trajectory and the current vehicle state.</li>
<li>derive the output equation of the discrete PID-Controller.</li>
<li>implement a longitudinal velocity controller and a cascaded lateral controller which outputs the desired yaw-rate.</li>
<li>utilize an inverse single-track model to calculate the desired steering angle from the desired yaw-rate.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-this-workshop">Introduction to this workshop<a href="#introduction-to-this-workshop" class="hash-link" aria-label="Direct link to Introduction to this workshop" title="Direct link to Introduction to this workshop">​</a></h2>
<p>The implementation of the compensatory feedback controller as low-level stabilization is the goal of this section.</p>
<p>In this exercise you have to formulate some parts of the controller structure for longitudinal and lateral control.
The architecture of the controller is given by the following illustration:</p>
<p><img decoding="async" loading="lazy" alt="ctr_arc" src="/Autonomous-Connected-Driving/assets/images/ctr_arc-cf9536dcba0fb3279c2bea747901587b.PNG" width="1086" height="502" class="img_ev3q"></p>
<p>The gaps for the tasks are located in the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/TrajectoryCtrl.cpp" target="_blank" rel="noopener noreferrer">TrajectoryCtrl.cpp</a> and in the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/PID.cpp" target="_blank" rel="noopener noreferrer">PID.cpp</a>-file.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-1-implementation-of-odometry-equations">Task 1: Implementation of odometry equations<a href="#task-1-implementation-of-odometry-equations" class="hash-link" aria-label="Direct link to Task 1: Implementation of odometry equations" title="Direct link to Task 1: Implementation of odometry equations">​</a></h2>
<p>In this task you have to implement the odometry equations to calculate the lateral and heading deviation of the vehicle to the trajectory. Therefore, open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/TrajectoryCtrl.cpp#L242" target="_blank" rel="noopener noreferrer">TrajectoryCtrl.cpp at Line 242</a> and fill in the gaps.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// START TASK 1 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double yawRate = cur_vehicle_state_.yaw_rate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double velocity = cur_vehicle_state_.velocity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">odom_dy_ += ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">odom_dpsi_ += ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// END TASK 1 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Hints:</em></p>
<ul>
<li>the vehicle yaw-rate can be accessed by the variable <code>yawRate</code></li>
<li>the vehicle velocity can be accessed by the variable <code>velocity</code></li>
<li>the time-step since the last odometry update can be accessed by the variable <code>dt</code></li>
<li>the lateral movement can be calculated by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>y</mi><mo>=</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>d</mi><mi>ψ</mi><mo>+</mo><mn>0.5</mn><mo>⋅</mo><mover accent="true"><mi>ψ</mi><mo>˙</mo></mover><mo>⋅</mo><mi>d</mi><mi>t</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>d</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">dy=sin(d\psi + 0.5 \cdot \dot{\psi} \cdot dt) \cdot ds</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em">ψ</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.1257em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.03588em">ψ</span></span><span style="top:-3.2634em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0278em"><span class="mord">˙</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">ds</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span></span></span></span> is the travelled distance of the vehicle since the last odometry calculation step</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-2-calculate-the-control-deviations">Task 2: Calculate the control deviations<a href="#task-2-calculate-the-control-deviations" class="hash-link" aria-label="Direct link to Task 2: Calculate the control deviations" title="Direct link to Task 2: Calculate the control deviations">​</a></h2>
<p>Now that you&#x27;ve implemented the odometry equations, we can use the odometry output to calculate the deviations of the vehicle to the current trajectory. Therefore, open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/TrajectoryCtrl.cpp#L196" target="_blank" rel="noopener noreferrer">TrajectoryCtrl.cpp at Line 196</a> and fill in the gaps. Use the following illustration as a hint for the implementation.</p>
<p><img decoding="async" loading="lazy" alt="trj_dev" src="/Autonomous-Connected-Driving/assets/images/trj_dev-9eb44b5dd8fa0d9d8b4bf5d795bc24e4.PNG" width="324" height="633" class="img_ev3q"></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// START TASK 2 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// calculate vehicle deviations from the trajectory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dy_ = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpsi_ = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// END TASK 2 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-3-implement-the-output-equation-of-a-discrete-pid-controller">Task 3: Implement the output equation of a discrete PID-Controller<a href="#task-3-implement-the-output-equation-of-a-discrete-pid-controller" class="hash-link" aria-label="Direct link to Task 3: Implement the output equation of a discrete PID-Controller" title="Direct link to Task 3: Implement the output equation of a discrete PID-Controller">​</a></h2>
<p>Now that the deviations of the vehicle from the given trajectory are computed, you are ready to implement a feedback control loop. In this section we will use discrete PID-Controllers. In this task you have to implement the output equation of a discrete PID-Controller. Therefore, open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/PID.cpp#L44" target="_blank" rel="noopener noreferrer">PID.cpp at Line 44</a> and fill in the gaps.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// START TASK 3 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// END TASK 3 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Hints</em>:</p>
<ul>
<li>the controller error is given by <code>e</code></li>
<li>the discrete integral value of the controller error is given by <code>i_val_</code></li>
<li>the discrete derivative value of the controller error is given by <code>d_val</code></li>
<li>the P-Gain of the controller is given by <code>Kp_</code></li>
<li>the I-Gain of the controller is given by <code>Ki_</code></li>
<li>the D-Gain of the controller is given by <code>Kd_</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-4-longitudinal-velocity-controller">Task 4: Longitudinal velocity controller<a href="#task-4-longitudinal-velocity-controller" class="hash-link" aria-label="Direct link to Task 4: Longitudinal velocity controller" title="Direct link to Task 4: Longitudinal velocity controller">​</a></h2>
<p>With the PID-Controller done, we can start implementing the actual control loop. We will start with an easy example which implements a longitudinal velocity controller. Therefore, open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/TrajectoryCtrl.cpp#L345" target="_blank" rel="noopener noreferrer">TrajectoryCtrl.cpp at Line 345</a> and fill in the gaps. Use the shown illustration as a hint for the implementation.</p>
<p><img decoding="async" loading="lazy" alt="lon_ctr" src="/Autonomous-Connected-Driving/assets/images/lon_ctr-975d91236faee57d41fc3fc32231b5fe.PNG" width="1033" height="461" class="img_ev3q"></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// START TASK 4 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double dt = ros::Time::now().toSec() - vhcl_ctrl_output_.header.stamp.toSec();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double velocity = cur_vehicle_state_.velocity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double w_v = v_tgt_;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double e_v = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double a_fb_v = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// END TASK 4 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Hints:</em></p>
<ul>
<li>the desired velocity is given by <code>w_v</code></li>
<li>the current vehicle velocity is given by <code>velocity</code></li>
<li>the discrete time-step is given by <code>dt</code></li>
<li>we&#x27;ve already implemented a velocity PID-Controller instance called <code>dv_pid</code> (using the class from PID.cpp)</li>
<li>the PID-Controller offers the method <code>Calc(double e, double dt)</code> which returns the controller output. Input values are the controller error <code>e</code> and the discrete time-step <code>dt</code>.</li>
<li>Given an exemplary PID-Controller instance named <code>pid</code>, you can then access the method by typing <code>double output = pid-&gt;Calc(e,dt)</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-5-cascaded-lateral-controller">Task 5: Cascaded lateral controller<a href="#task-5-cascaded-lateral-controller" class="hash-link" aria-label="Direct link to Task 5: Cascaded lateral controller" title="Direct link to Task 5: Cascaded lateral controller">​</a></h2>
<p>Now that the basic implementation of the PID controller is done, we can start with implementing the cascaded lateral feedback-controller. Open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/TrajectoryCtrl.cpp#L262" target="_blank" rel="noopener noreferrer">TrajectoryCtrl.cpp at Line 262</a> and fill in the gaps. Use the following illustration as a hint for the implementation.</p>
<p><img decoding="async" loading="lazy" alt="lat_ctr" src="/Autonomous-Connected-Driving/assets/images/lat_ctr-6b1b7fdcf557cfee1c10e0f15c069027.PNG" width="1103" height="505" class="img_ev3q"></p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// START TASK 5 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double dt = (ros::Time::now() - vhcl_ctrl_output_.header.stamp).toSec();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double w_y = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double e_y = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double w_psi = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double e_psi = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double psi_dot_des = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// END TASK 5 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Hints:</em></p>
<ul>
<li>the discrete time-step is given by <code>dt</code></li>
<li>the lateral deviation of the vehicle from the trajectory is given by <code>dy_</code></li>
<li>the heading deviation of the vehicle from the trajectory is given by <code>dpsi_</code></li>
<li>we&#x27;ve already created the dpsi- and dy-PID-Controller instances (called <code>dpsi_pid</code> and <code>dy_pid</code>, using the class from PID.cpp)</li>
<li>the PID-Controller offers the method <code>Calc(double e, double dt)</code> which returns the controller output. Input values are the controller error <code>e</code> and the discrete time-step <code>dt</code>.</li>
<li>Given an exemplary PID-Controller instance named <code>pid</code>, you can then access the method by typing <code>double output = pid-&gt;Calc(e,dt)</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-6-inverse-single-track-model">Task 6: Inverse single-track model<a href="#task-6-inverse-single-track-model" class="hash-link" aria-label="Direct link to Task 6: Inverse single-track model" title="Direct link to Task 6: Inverse single-track model">​</a></h2>
<p>The cascaded lateral controller implemented in task 4.5 computes the desired yaw-rate, but in our case, the output of the lateral controller should be the steering angle. Therefore, you have to implement an inverse single-track model to calculate the steering angle from a desired yaw-rate. Open the <a href="https://github.com/ika-rwth-aachen/acdc/blob/main/catkin_workspace/src/workshops/section_4/trajectory_ctrl/src/TrajectoryCtrl.cpp#L287" target="_blank" rel="noopener noreferrer">TrajectoryCtrl.cpp at Line 287</a> and fill in the gaps.</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// START TASK 6 CODE HERE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// use helping comments from Wiki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">double st_ang_pid = ?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// END TASK 6 CODE HERE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Hints:</em></p>
<ul>
<li>the vehicles self-steering-gradient is given by <code>self_st_gradient_</code></li>
<li>the vehicles wheelbase is given by <code>wheelbase_</code></li>
<li>the vehicles velocity is given by <code>velocity</code></li>
<li>the desired yaw-rate is given by <code>psi_dot_des</code></li>
<li>the inverse single-track model (stationary approach) is defined by: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mo>=</mo><mover accent="true"><mi>ψ</mi><mo>˙</mo></mover><mo>⋅</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>l</mi><mo>+</mo><mi>E</mi><mi>G</mi><mo>⋅</mo><msup><mi>v</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><mi>v</mi></mfrac></mrow><annotation encoding="application/x-tex">\delta = \dot{\psi} \cdot \frac{(l + EG \cdot v^2)}{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.1257em;vertical-align:-0.1944em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9313em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:0.03588em">ψ</span></span><span style="top:-3.2634em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.0278em"><span class="mord">˙</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.4539em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1089em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">v</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.485em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">EG</span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em"><span style="top:-2.931em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> (the self-steering-gradient is denoted as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mi>G</mi></mrow><annotation encoding="application/x-tex">EG</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">EG</span></span></span></span>)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="result">Result<a href="#result" class="hash-link" aria-label="Direct link to Result" title="Direct link to Result">​</a></h2>
<p>When you are done with the implementation start the docker container (<code>cd acdc/docker</code> and <code>./ros1_run.sh</code>) and build the workspace:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">catkin build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source devel/setup.bash # make sure to execute this line in each of the following terminals!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you&#x27;re ready to start the simulation:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">roslaunch trajectory_planner vehicle_guidance.launch</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you need a dynamic object which you can follow, play the bag-file from the previous workshops in another terminal (inside the docker container) when the first trajectory appears:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rosbag play ~/ws/bag/acdc_fusion_guidance_noise.bag</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The overall result should look like this:</p>
<p><img decoding="async" loading="lazy" alt="solution" src="/Autonomous-Connected-Driving/assets/images/sol_control-d4c6daa4c1c52786190644cc43473c7a.gif" width="666" height="360" class="img_ev3q"></p>
<p>As you can see, the vehicle follows the given trajectory significantly better than using only the result of the previous workshop.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bonus-task">Bonus Task<a href="#bonus-task" class="hash-link" aria-label="Direct link to Bonus Task" title="Direct link to Bonus Task">​</a></h2>
<p>While running the simulation, open a new terminal and enter the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source devel/setup.bash # make sure to execute this line in each of the following terminals!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rosrun rqt_reconfigure rqt_reconfigure</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A new window will open:</p>
<p><img decoding="async" loading="lazy" alt="solution" src="/Autonomous-Connected-Driving/assets/images/section_4_dyn_reconf-7f2216a25cd1b89672a695146e86c4b2.png" width="933" height="974" class="img_ev3q"></p>
<p>By moving the sliders you can adjust various parameters of the trajectory planner and the trajectory controller. By setting all controller gains (<code>dv_P</code>, <code>dv_I</code>, <code>dv_D</code>, ...) to 0, the vehicle will behave like in the previous workshop, as the output of the feedback controllers is always 0.
Moreover, you can also set the <code>deviationMax...</code> parameters of the trajectory planner to 0. The planner then acts as a pure MPC, as it is reinitialized every optimization step. Both methods therefore disable the low-level stabilization and only the high-level stabilization of the trajectory planner is used.</p>
<p>Furthermore, you can adjust the weight and reference factors of the cost function you implemented in section the previous workshop.
Feel free to play with the parameters and observe how the vehicle behaves.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrap-up">Wrap-up<a href="#wrap-up" class="hash-link" aria-label="Direct link to Wrap-up" title="Direct link to Wrap-up">​</a></h2>
<p>In this workshop you learned...</p>
<ul>
<li>how to implement the odometry equations to calculate the lateral and heading deviation of the vehicle to the trajectory.</li>
<li>to calculate the control deviations using target values given by the trajectory and the current vehicle state.</li>
<li>how to derive the output equation of the discrete PID-Controller.</li>
<li>to implement a longitudinal velocity controller and a cascaded lateral controller which outputs the desired yaw-rate.</li>
<li>how to utilize an inverse single-track model to calculate the desired steering angle from the desired yaw-rate.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li><a href="/Autonomous-Connected-Driving/docs/task/vehicle_guidance/s">Control Toolbox</a></li>
</ul>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@article{adrlCT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  title={The control toolbox — An open-source C++ library for robotics, optimal and model predictive control},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  author={Markus Giftthaler and Michael Neunert and Markus St{\&quot;a}uble and Jonas Buchli},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  journal={2018 IEEE International Conference on Simulation, Modeling, and Programming for Autonomous Robots (SIMPAR)},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  year={2018},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pages={123-129}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><a href="https://github.com/avidbots/flatland" target="_blank" rel="noopener noreferrer">Flatland</a></li>
<li><a href="https://www.ros.org" target="_blank" rel="noopener noreferrer">ROS</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/task/04_vehicle_guidance/01_Trajectory-Control.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Autonomous-Connected-Driving/docs/category/vehicle-guidance"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Vehicle Guidance</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Autonomous-Connected-Driving/docs/task/vehicle_guidance/Trajectory-Planning"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Trajectory Planning</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-to-this-workshop" class="table-of-contents__link toc-highlight">Introduction to this workshop</a></li><li><a href="#task-1-implementation-of-odometry-equations" class="table-of-contents__link toc-highlight">Task 1: Implementation of odometry equations</a></li><li><a href="#task-2-calculate-the-control-deviations" class="table-of-contents__link toc-highlight">Task 2: Calculate the control deviations</a></li><li><a href="#task-3-implement-the-output-equation-of-a-discrete-pid-controller" class="table-of-contents__link toc-highlight">Task 3: Implement the output equation of a discrete PID-Controller</a></li><li><a href="#task-4-longitudinal-velocity-controller" class="table-of-contents__link toc-highlight">Task 4: Longitudinal velocity controller</a></li><li><a href="#task-5-cascaded-lateral-controller" class="table-of-contents__link toc-highlight">Task 5: Cascaded lateral controller</a></li><li><a href="#task-6-inverse-single-track-model" class="table-of-contents__link toc-highlight">Task 6: Inverse single-track model</a></li><li><a href="#result" class="table-of-contents__link toc-highlight">Result</a></li><li><a href="#bonus-task" class="table-of-contents__link toc-highlight">Bonus Task</a></li><li><a href="#wrap-up" class="table-of-contents__link toc-highlight">Wrap-up</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Coding</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/cpp/content">C++</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/python/content">Python</a></li></ul></div><div class="col footer__col"><div class="footer__title">Robot Operating System</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros/content">ROS</a></li><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/docs/ros2/content">ROS2</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Autonomous-Connected-Driving/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/CagriCatik/Autonomous-Connected-Driving" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 - Automated and Connected Driving.</div></div></div></footer></div>
</body>
</html>